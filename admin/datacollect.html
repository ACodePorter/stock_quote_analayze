<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据采集 - 管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.2.0/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.2.0/dist/index.css">
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- 头部 -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-chart-bar text-green-600 text-xl mr-2"></i>
                        <h1 class="text-xl font-semibold text-gray-900">管理后台</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-700">管理员</span>
                        <i class="fas fa-user-circle text-gray-400 text-xl"></i>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- 侧边栏 -->
            <aside class="w-64 bg-white shadow-sm min-h-screen">
                <div class="p-4">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-chart-bar text-green-600 text-xl mr-2"></i>
                        <h2 class="text-lg font-semibold text-gray-900">管理后台</h2>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">管理员</div>
                    
                    <nav class="space-y-2">
                        <a href="dashboard.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-clipboard-list mr-3"></i>
                            仪表板
                        </a>
                        <a href="users.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-users mr-3"></i>
                            用户管理
                        </a>
                        <a href="quotes.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-chart-line mr-3"></i>
                            行情数据
                        </a>
                        <a href="datasource.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-cog mr-3"></i>
                            数据源配置
                        </a>
                        <a href="datacollect.html" class="flex items-center px-3 py-2 bg-blue-100 text-blue-700 rounded-md">
                            <i class="fas fa-download mr-3"></i>
                            数据采集
                        </a>
                        <a href="monitor.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-desktop mr-3"></i>
                            系统监控
                        </a>
                        <a href="prediction.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-lightbulb mr-3"></i>
                            预测模型
                        </a>
                        <a href="logs.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-file-alt mr-3"></i>
                            系统日志
                        </a>
                        <a href="content.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-file-lines mr-3"></i>
                            内容管理
                        </a>
                        <a href="announcement.html" class="flex items-center px-3 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="fas fa-bell mr-3"></i>
                            公告发布
                        </a>
                    </nav>
                    
                    <div class="mt-8">
                        <button class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                            退出登录
                        </button>
                    </div>
                </div>
            </aside>

            <!-- 主内容区 -->
            <main class="flex-1 p-8">
                <!-- 面包屑导航 -->
                <nav class="text-sm text-gray-500 mb-6">
                    <span>管理后台</span>
                    <span class="mx-2">/</span>
                    <span>数据采集</span>
                </nav>

                <!-- 页面标题 -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">数据采集</h1>
                </div>

                <!-- 当前任务状态 -->
                <div v-if="currentTask" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-yellow-800">当前有任务正在运行</h3>
                            <p class="text-sm text-yellow-700 mt-1">
                                任务ID: {{ currentTask.task_id }} | 
                                开始时间: {{ formatTime(currentTask.start_time) }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 数据采集功能 -->
                <div class="bg-white rounded-lg shadow-sm border p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-chart-bar text-gray-400 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">历史数据采集</h2>
                        <p class="text-gray-600">使用akshare采集A股历史行情数据（单任务执行，防重复采集）</p>
                    </div>

                    <!-- 采集配置表单 -->
                    <div class="max-w-2xl mx-auto">
                        <form @submit.prevent="startCollection" class="space-y-6">
                            <!-- 日期范围 -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">开始日期</label>
                                    <input 
                                        type="date" 
                                        v-model="form.start_date"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">结束日期</label>
                                    <input 
                                        type="date" 
                                        v-model="form.end_date"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                </div>
                            </div>

                            <!-- 股票选择 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">股票选择</label>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input 
                                            type="radio" 
                                            v-model="form.collection_type" 
                                            value="single"
                                            class="mr-2"
                                        >
                                        单个股票采集
                                    </label>
                                    <label class="flex items-center">
                                        <input 
                                            type="radio" 
                                            v-model="form.collection_type" 
                                            value="multiple"
                                            class="mr-2"
                                        >
                                        多个股票采集
                                    </label>
                                    <label class="flex items-center">
                                        <input 
                                            type="radio" 
                                            v-model="form.collection_type" 
                                            value="all"
                                            class="mr-2"
                                        >
                                        全量股票采集
                                    </label>
                                </div>
                            </div>

                            <!-- 单个股票代码输入 -->
                            <div v-if="form.collection_type === 'single'">
                                <label class="block text-sm font-medium text-gray-700 mb-2">股票代码</label>
                                <input 
                                    type="text" 
                                    v-model="form.single_stock_code"
                                    placeholder="请输入股票代码，例如：000001"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                >
                                <p class="text-sm text-gray-500 mt-1">支持输入单个股票代码进行采集</p>
                            </div>

                            <!-- 多个股票代码输入 -->
                            <div v-if="form.collection_type === 'multiple'">
                                <label class="block text-sm font-medium text-gray-700 mb-2">股票代码</label>
                                <textarea 
                                    v-model="form.stock_codes_text"
                                    placeholder="请输入股票代码，每行一个，例如：&#10;000001&#10;000002&#10;000858"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="5"
                                    required
                                ></textarea>
                                <p class="text-sm text-gray-500 mt-1">支持输入多个股票代码，每行一个</p>
                            </div>

                            <!-- 全量采集说明 -->
                            <div v-if="form.collection_type === 'all'" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                                    <div>
                                        <h3 class="text-sm font-medium text-blue-800">全量采集说明</h3>
                                        <p class="text-sm text-blue-700 mt-1">
                                            将采集数据库中所有股票的历史数据。由于akshare限流要求，系统采用单任务执行模式，
                                            已采集过的股票数据将被跳过，避免重复采集。
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- 测试模式 -->
                            <div>
                                <label class="flex items-center">
                                    <input 
                                        type="checkbox" 
                                        v-model="form.test_mode"
                                        class="mr-2"
                                    >
                                    <span class="text-sm font-medium text-gray-700">测试模式（只采集前5只股票）</span>
                                </label>
                            </div>

                            <!-- 操作按钮 -->
                            <div class="flex space-x-4">
                                <button 
                                    type="submit" 
                                    :disabled="loading || currentTask"
                                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <i v-if="loading" class="fas fa-spinner fa-spin mr-2"></i>
                                    {{ loading ? '启动中...' : (currentTask ? '等待当前任务完成' : '开始采集') }}
                                </button>
                                <button 
                                    type="button" 
                                    @click="resetForm"
                                    class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600"
                                >
                                    重置
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 任务列表 -->
                <div class="mt-8 bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">采集任务</h3>
                        <button 
                            @click="loadTasks"
                            class="text-blue-600 hover:text-blue-800 text-sm"
                        >
                            <i class="fas fa-refresh mr-1"></i>
                            刷新
                        </button>
                    </div>
                    <div class="p-6">
                        <div v-if="tasks.length === 0" class="text-center text-gray-500 py-8">
                            暂无采集任务
                        </div>
                        <div v-else class="space-y-4">
                            <div 
                                v-for="task in tasks" 
                                :key="task.task_id"
                                class="border rounded-lg p-4 hover:bg-gray-50"
                            >
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">任务 {{ task.task_id }}</h4>
                                        <p class="text-sm text-gray-500">
                                            {{ formatTime(task.start_time) }} - {{ task.end_time ? formatTime(task.end_time) : '进行中' }}
                                        </p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span 
                                            :class="{
                                                'bg-green-100 text-green-800': task.status === 'completed',
                                                'bg-blue-100 text-blue-800': task.status === 'running',
                                                'bg-red-100 text-red-800': task.status === 'failed',
                                                'bg-yellow-100 text-yellow-800': task.status === 'cancelled'
                                            }"
                                            class="px-2 py-1 rounded-full text-xs font-medium"
                                        >
                                            {{ getStatusText(task.status) }}
                                        </span>
                                        <button 
                                            v-if="task.status === 'running'"
                                            @click="cancelTask(task.task_id)"
                                            class="text-red-600 hover:text-red-800 text-sm"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 进度条 -->
                                <div v-if="task.status === 'running'" class="mb-3">
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span>进度</span>
                                        <span>{{ task.progress }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div 
                                            class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                            :style="{ width: task.progress + '%' }"
                                        ></div>
                                    </div>
                                </div>

                                <!-- 统计信息 -->
                                <div class="grid grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-500">总股票数:</span>
                                        <span class="font-medium">{{ task.total_stocks }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">成功:</span>
                                        <span class="font-medium text-green-600">{{ task.success_count }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">失败:</span>
                                        <span class="font-medium text-red-600">{{ task.failed_count }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">新增数据:</span>
                                        <span class="font-medium text-blue-600">{{ task.collected_count }}</span>
                                    </div>
                                </div>

                                <!-- 错误信息 -->
                                <div v-if="task.error_message" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <p class="text-sm text-red-800">{{ task.error_message }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    form: {
                        start_date: '',
                        end_date: '',
                        collection_type: 'single',
                        single_stock_code: '',
                        stock_codes_text: '',
                        test_mode: false
                    },
                    tasks: [],
                    currentTask: null,
                    loading: false,
                    pollingInterval: null
                }
            },
            mounted() {
                this.loadTasks();
                this.loadCurrentTask();
                this.startPolling();
            },
            beforeUnmount() {
                this.stopPolling();
            },
            methods: {
                async startCollection() {
                    try {
                        this.loading = true;
                        
                        // 检查当前任务状态
                        if (this.currentTask) {
                            ElMessage.error('已有采集任务正在运行，请等待完成后再启动新任务');
                            return;
                        }
                        
                        // 准备请求数据
                        const requestData = {
                            start_date: this.form.start_date,
                            end_date: this.form.end_date,
                            test_mode: this.form.test_mode
                        };

                        // 根据采集类型设置股票代码
                        if (this.form.collection_type === 'single') {
                            if (!this.form.single_stock_code.trim()) {
                                ElMessage.error('请输入股票代码');
                                return;
                            }
                            requestData.stock_codes = [this.form.single_stock_code.trim()];
                        } else if (this.form.collection_type === 'multiple') {
                            const stockCodes = this.form.stock_codes_text
                                .split('\n')
                                .map(code => code.trim())
                                .filter(code => code.length > 0);
                            
                            if (stockCodes.length === 0) {
                                ElMessage.error('请输入至少一个股票代码');
                                return;
                            }
                            
                            requestData.stock_codes = stockCodes;
                        }
                        // 全量采集不需要设置stock_codes

                        const response = await axios.post('/data-collection/historical', requestData);
                        
                        if (response.data.status === 'started') {
                            ElMessage.success('采集任务已启动');
                            this.loadTasks();
                            this.loadCurrentTask();
                        }
                        
                    } catch (error) {
                        console.error('启动采集任务失败:', error);
                        const errorMsg = error.response?.data?.detail || '启动采集任务失败';
                        ElMessage.error(errorMsg);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadTasks() {
                    try {
                        const response = await axios.get('/data-collection/tasks');
                        this.tasks = response.data;
                    } catch (error) {
                        console.error('加载任务列表失败:', error);
                    }
                },

                async loadCurrentTask() {
                    try {
                        const response = await axios.get('/data-collection/current-task');
                        this.currentTask = response.data.current_task;
                    } catch (error) {
                        console.error('加载当前任务信息失败:', error);
                    }
                },

                async cancelTask(taskId) {
                    try {
                        await ElMessageBox.confirm('确定要取消这个任务吗？', '确认取消', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        await axios.delete(`/data-collection/tasks/${taskId}`);
                        ElMessage.success('任务已取消');
                        this.loadTasks();
                        this.loadCurrentTask();
                        
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('取消任务失败:', error);
                            ElMessage.error(error.response?.data?.detail || '取消任务失败');
                        }
                    }
                },

                resetForm() {
                    this.form = {
                        start_date: '',
                        end_date: '',
                        collection_type: 'single',
                        single_stock_code: '',
                        stock_codes_text: '',
                        test_mode: false
                    };
                },

                getStatusText(status) {
                    const statusMap = {
                        'running': '运行中',
                        'completed': '已完成',
                        'failed': '失败',
                        'cancelled': '已取消'
                    };
                    return statusMap[status] || status;
                },

                formatTime(timeStr) {
                    if (!timeStr) return '';
                    const date = new Date(timeStr);
                    return date.toLocaleString('zh-CN');
                },

                startPolling() {
                    this.pollingInterval = setInterval(() => {
                        this.loadTasks();
                        this.loadCurrentTask();
                    }, 5000); // 每5秒刷新一次
                },

                stopPolling() {
                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval);
                        this.pollingInterval = null;
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
