<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自选股功能测试 - 股票分析</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/common.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        .stock-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .watchlist-toggle {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .watchlist-toggle.active {
            background: #dc3545;
        }
        .watchlist-toggle:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>自选股功能测试页面</h1>
        
        <div class="test-section">
            <h3>1. 用户认证状态</h3>
            <button class="test-button" onclick="checkAuthStatus()">检查登录状态</button>
            <button class="test-button" onclick="getUserInfo()">获取用户信息</button>
            <div id="authResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>2. 股票信息</h3>
            <div class="stock-info">
                <div>
                    <strong>股票代码:</strong> <span id="stockCode">000001</span><br>
                    <strong>股票名称:</strong> <span id="stockName">平安银行</span>
                </div>
                <button class="watchlist-toggle" id="watchlistBtn" onclick="toggleWatchlist()">⭐ 自选</button>
            </div>
        </div>

        <div class="test-section">
            <h3>3. 自选股操作</h3>
            <button class="test-button" onclick="checkWatchlistStatus()">检查自选股状态</button>
            <button class="test-button" onclick="addToWatchlist()">添加到自选股</button>
            <button class="test-button" onclick="removeFromWatchlist()">从自选股删除</button>
            <button class="test-button" onclick="getWatchlist()">获取自选股列表</button>
            <div id="watchlistResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>4. 测试结果</h3>
            <div id="testResult" class="test-result"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/common.js"></script>
    <script>
        // 测试用的股票信息
        const testStock = {
            code: '000001',
            name: '平安银行'
        };

        // 显示测试结果
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            element.style.borderLeftColor = type === 'error' ? '#dc3545' : 
                                          type === 'success' ? '#28a745' : '#007bff';
        }

        // 检查认证状态
        async function checkAuthStatus() {
            try {
                const response = await authFetch(`${API_BASE_URL}/api/auth/status`);
                const result = await response.json();
                
                if (result.success && result.logged_in) {
                    showResult('authResult', `用户已登录: ${result.user.username}`, 'success');
                } else {
                    showResult('authResult', '用户未登录', 'error');
                }
            } catch (error) {
                showResult('authResult', `检查认证状态失败: ${error.message}`, 'error');
            }
        }

        // 获取用户信息
        function getUserInfo() {
            const userInfo = CommonUtils.auth.getUserInfo();
            if (userInfo && userInfo.id) {
                showResult('authResult', `用户ID: ${userInfo.id}, 用户名: ${userInfo.username}`, 'success');
            } else {
                showResult('authResult', '未获取到用户信息', 'error');
            }
        }

        // 检查自选股状态
        async function checkWatchlistStatus() {
            try {
                const userInfo = CommonUtils.auth.getUserInfo();
                if (!userInfo || !userInfo.id) {
                    showResult('watchlistResult', '请先登录', 'error');
                    return;
                }

                const response = await authFetch(`${API_BASE_URL}/api/watchlist?user_id=${userInfo.id}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const isInWatchlist = result.data.some(item => item.code === testStock.code);
                    updateWatchlistButton(isInWatchlist);
                    showResult('watchlistResult', `股票 ${testStock.code} 自选股状态: ${isInWatchlist ? '已在自选股中' : '未在自选股中'}`, 'success');
                } else {
                    showResult('watchlistResult', '获取自选股列表失败', 'error');
                }
            } catch (error) {
                showResult('watchlistResult', `检查自选股状态失败: ${error.message}`, 'error');
            }
        }

        // 更新自选股按钮状态
        function updateWatchlistButton(isInWatchlist) {
            const btn = document.getElementById('watchlistBtn');
            if (isInWatchlist) {
                btn.classList.add('active');
                btn.textContent = '⭐ 已自选';
            } else {
                btn.classList.remove('active');
                btn.textContent = '⭐ 自选';
            }
        }

        // 切换自选股状态
        async function toggleWatchlist() {
            try {
                const userInfo = CommonUtils.auth.getUserInfo();
                if (!userInfo || !userInfo.id) {
                    showResult('watchlistResult', '请先登录后再操作自选股', 'error');
                    return;
                }

                const btn = document.getElementById('watchlistBtn');
                const isInWatchlist = btn.classList.contains('active');

                if (isInWatchlist) {
                    await removeFromWatchlist();
                } else {
                    await addToWatchlist();
                }
            } catch (error) {
                showResult('watchlistResult', `操作自选股失败: ${error.message}`, 'error');
            }
        }

        // 添加到自选股
        async function addToWatchlist() {
            try {
                const userInfo = CommonUtils.auth.getUserInfo();
                const response = await authFetch(`${API_BASE_URL}/api/watchlist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userInfo.id,
                        stock_code: testStock.code,
                        stock_name: testStock.name,
                        group_name: 'default'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    updateWatchlistButton(true);
                    showResult('watchlistResult', `已添加 ${testStock.name} 到自选股`, 'success');
                } else {
                    showResult('watchlistResult', result.detail || '添加失败', 'error');
                }
            } catch (error) {
                showResult('watchlistResult', `添加自选股失败: ${error.message}`, 'error');
            }
        }

        // 从自选股中删除
        async function removeFromWatchlist() {
            try {
                const userInfo = CommonUtils.auth.getUserInfo();
                const response = await authFetch(`${API_BASE_URL}/api/watchlist/delete_by_code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userInfo.id,
                        stock_code: testStock.code
                    })
                });

                const result = await response.json();
                if (result.success) {
                    updateWatchlistButton(false);
                    showResult('watchlistResult', `已从自选股中移除 ${testStock.name}`, 'success');
                } else {
                    showResult('watchlistResult', result.detail || '删除失败', 'error');
                }
            } catch (error) {
                showResult('watchlistResult', `删除自选股失败: ${error.message}`, 'error');
            }
        }

        // 获取自选股列表
        async function getWatchlist() {
            try {
                const userInfo = CommonUtils.auth.getUserInfo();
                if (!userInfo || !userInfo.id) {
                    showResult('watchlistResult', '请先登录', 'error');
                    return;
                }

                const response = await authFetch(`${API_BASE_URL}/api/watchlist?user_id=${userInfo.id}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const watchlistHtml = result.data.map(item => 
                        `<div>${item.code} - ${item.name} (${item.group_name || 'default'})</div>`
                    ).join('');
                    showResult('watchlistResult', `自选股列表 (共${result.data.length}只):<br>${watchlistHtml}`, 'success');
                } else {
                    showResult('watchlistResult', '获取自选股列表失败', 'error');
                }
            } catch (error) {
                showResult('watchlistResult', `获取自选股列表失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 设置股票信息
            document.getElementById('stockCode').textContent = testStock.code;
            document.getElementById('stockName').textContent = testStock.name;
            
            // 自动检查认证状态
            checkAuthStatus();
        });
    </script>
</body>
</html>
