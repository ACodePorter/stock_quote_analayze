<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票自选股功能测试 - 股票分析</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/stock.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            margin: 10px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- 头部导航将由JavaScript动态加载 -->
    <script src="components/header.js"></script>
    <script>loadHeader('test');</script>

    <!-- 主要内容 -->
    <main class="main-content">
        <div class="container">
            <h1>股票自选股功能测试</h1>
            
            <!-- 测试股票信息 -->
            <div class="test-section">
                <h2>测试股票信息</h2>
                <p><strong>股票代码:</strong> <span id="testStockCode">000001</span></p>
                <p><strong>股票名称:</strong> <span id="testStockName">平安银行</span></p>
                <p><strong>自选股状态:</strong> <span id="watchlistStatus">未知</span></p>
            </div>

            <!-- 自选股按钮测试 -->
            <div class="test-section">
                <h2>自选股按钮测试</h2>
                <button class="watchlist-toggle">⭐ 自选</button>
                <p>点击按钮测试自选股添加/删除功能</p>
            </div>

            <!-- 功能测试 -->
            <div class="test-section">
                <h2>功能测试</h2>
                <button class="test-button" onclick="testCheckWatchlistStatus()">检查自选股状态</button>
                <button class="test-button" onclick="testAddToWatchlist()">测试添加到自选股</button>
                <button class="test-button" onclick="testRemoveFromWatchlist()">测试从自选股删除</button>
                <button class="test-button" onclick="testToggleWatchlist()">测试切换自选股状态</button>
            </div>

            <!-- 测试结果 -->
            <div class="test-section">
                <h2>测试结果</h2>
                <div id="testResults"></div>
            </div>
        </div>
    </main>

    <!-- 引入必要的JavaScript文件 -->
    <script src="js/config.js"></script>
    <script src="js/common.js"></script>
    <script src="js/stock.js"></script>
    
    <script>
        // 测试用的股票信息
        const testStock = {
            code: '000001',
            name: '平安银行'
        };

        // 模拟StockPage对象
        const TestStockPage = {
            stockCode: testStock.code,
            stockName: testStock.name,
            isInWatchlist: false,

            // 检查自选股状态
            async checkWatchlistStatus() {
                try {
                    // 检查用户是否已登录
                    const userInfo = CommonUtils.auth.getUserInfo();
                    if (!userInfo || !userInfo.id) {
                        console.log('用户未登录，跳过自选股状态检查');
                        return;
                    }

                    // 调用后端API获取用户自选股列表
                    const res = await authFetch(`${API_BASE_URL}/api/watchlist`);
                    const result = await res.json();
                    
                    if (result.success && result.data) {
                        // 检查当前股票是否在自选股列表中
                        this.isInWatchlist = result.data.some(item => item.code === this.stockCode);
                        console.log(`股票 ${this.stockCode} 自选股状态:`, this.isInWatchlist);
                    } else {
                        this.isInWatchlist = false;
                    }
                } catch (error) {
                    console.error('检查自选股状态失败:', error);
                    this.isInWatchlist = false;
                }
                
                // 更新按钮显示
                this.updateWatchlistButton();
                this.updateStatusDisplay();
            },

            // 更新自选股按钮状态
            updateWatchlistButton() {
                const toggleBtn = document.querySelector('.watchlist-toggle');
                if (!toggleBtn) return;
                
                if (this.isInWatchlist) {
                    toggleBtn.classList.add('active');
                    toggleBtn.textContent = '⭐ 已自选';
                } else {
                    toggleBtn.classList.remove('active');
                    toggleBtn.textContent = '⭐ 自选';
                }
            },

            // 更新状态显示
            updateStatusDisplay() {
                const statusElement = document.getElementById('watchlistStatus');
                if (statusElement) {
                    statusElement.textContent = this.isInWatchlist ? '已自选' : '未自选';
                    statusElement.style.color = this.isInWatchlist ? 'green' : 'red';
                }
            },

            // 切换自选股状态
            async toggleWatchlist() {
                // 检查用户登录状态
                const userInfo = CommonUtils.auth.getUserInfo();
                if (!userInfo || !userInfo.id) {
                    CommonUtils.showToast('请先登录后再操作自选股', 'warning');
                    return;
                }

                if (this.isInWatchlist) {
                    // 从自选股中删除
                    await this.removeFromWatchlist();
                } else {
                    // 添加到自选股
                    await this.addToWatchlist();
                }
            },

            // 添加到自选股
            async addToWatchlist() {
                try {
                    const userInfo = CommonUtils.auth.getUserInfo();
                    const res = await authFetch(`${API_BASE_URL}/api/watchlist`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userInfo.id,
                            stock_code: this.stockCode,
                            stock_name: this.stockName,
                            group_name: 'default'
                        })
                    });
                    
                    const result = await res.json();
                    if (result.success) {
                        this.isInWatchlist = true;
                        this.updateWatchlistButton();
                        this.updateStatusDisplay();
                        CommonUtils.showToast(`已添加 ${this.stockName} 到自选股`, 'success');
                        return true;
                    } else {
                        CommonUtils.showToast(result.message || '添加失败', 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('添加到自选股失败:', error);
                    CommonUtils.showToast('网络错误，添加失败', 'error');
                    return false;
                }
            },

            // 从自选股删除
            async removeFromWatchlist() {
                try {
                    const userInfo = CommonUtils.auth.getUserInfo();
                    const res = await authFetch(`${API_BASE_URL}/api/watchlist/delete_by_code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userInfo.id,
                            stock_code: this.stockCode
                        })
                    });
                    
                    const result = await res.json();
                    if (result.success) {
                        this.isInWatchlist = false;
                        this.updateWatchlistButton();
                        this.updateStatusDisplay();
                        CommonUtils.showToast(`已从自选股中移除 ${this.stockName}`, 'info');
                        return true;
                    } else {
                        CommonUtils.showToast(result.message || '删除失败', 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('从自选股删除失败:', error);
                    CommonUtils.showToast('网络错误，删除失败', 'error');
                    return false;
                }
            }
        };

        // 绑定自选股按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.querySelector('.watchlist-toggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    TestStockPage.toggleWatchlist();
                });
            }

            // 初始化时检查自选股状态
            setTimeout(() => {
                TestStockPage.checkWatchlistStatus();
            }, 1000);
        });

        // 测试函数
        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultElement = document.createElement('div');
            resultElement.className = 'test-result';
            resultElement.style.borderLeft = `4px solid ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}`;
            resultElement.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsDiv.appendChild(resultElement);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testCheckWatchlistStatus() {
            addTestResult('开始检查自选股状态...');
            await TestStockPage.checkWatchlistStatus();
            addTestResult(`自选股状态检查完成: ${TestStockPage.isInWatchlist ? '已自选' : '未自选'}`, 'success');
        }

        async function testAddToWatchlist() {
            addTestResult('开始测试添加到自选股...');
            const result = await TestStockPage.addToWatchlist();
            if (result) {
                addTestResult('添加到自选股测试成功', 'success');
            } else {
                addTestResult('添加到自选股测试失败', 'error');
            }
        }

        async function testRemoveFromWatchlist() {
            addTestResult('开始测试从自选股删除...');
            const result = await TestStockPage.removeFromWatchlist();
            if (result) {
                addTestResult('从自选股删除测试成功', 'success');
            } else {
                addTestResult('从自选股删除测试失败', 'error');
            }
        }

        async function testToggleWatchlist() {
            addTestResult('开始测试切换自选股状态...');
            await TestStockPage.toggleWatchlist();
            addTestResult('切换自选股状态测试完成', 'success');
        }
    </script>
</body>
</html>
