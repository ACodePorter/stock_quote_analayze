# 股票搜索功能设计文档

## 1. 功能概述

### 1.1 功能描述
在各频道head区域实现股票搜索功能，支持用户通过股票代码或名称进行模糊查询，搜索后跳转到股票详情页面。

### 1.2 功能目标
- 在header区域提供全局搜索入口
- 支持股票代码和名称的模糊查询
- 登录成功后预加载股票参数信息，提升搜索性能
- 搜索结果支持键盘导航和点击跳转

## 2. 需求分析

### 2.1 功能需求
1. **搜索入口**：在header区域的搜索按钮点击后显示搜索模态框
2. **搜索功能**：支持输入股票代码或名称进行模糊查询
3. **数据加载**：用户登录成功后，自动加载所有股票参数信息并全局保存
4. **搜索结果**：显示匹配的股票列表，支持点击或键盘选择
5. **页面跳转**：选择股票后跳转到股票详情页面，传递股票代码和名称参数

### 2.2 非功能需求
- 搜索响应时间：< 300ms（使用本地缓存时）
- 搜索结果数量：最多显示20条
- 支持键盘导航：方向键、Enter、Esc
- 兼容性：支持所有现代浏览器

## 3. 技术设计

### 3.1 架构设计

```
前端架构:
┌─────────────────────────────────────┐
│         Header Component            │
│  ┌───────────────────────────────┐  │
│  │   搜索按钮 (🔍)              │  │
│  └───────────────────────────────┘  │
│          ↓ 点击显示                │
│  ┌───────────────────────────────┐  │
│  │     搜索模态框                 │  │
│  │  ┌─────────────────────────┐ │  │
│  │  │  输入框 (支持防抖)        │ │  │
│  │  └─────────────────────────┘ │  │
│  │  ┌─────────────────────────┐ │  │
│  │  │  搜索结果列表 (最多20条) │ │  │
│  │  └─────────────────────────┘ │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
         ↓ 选择股票
    ┌──────────────┐
    │ stock.html   │
    │ ?code=xxx    │
    │ &name=xxx    │
    └──────────────┘

后端架构:
┌─────────────────────────────────────┐
│      FastAPI Backend               │
│  ┌───────────────────────────────┐  │
│  │  GET /api/stock/list          │  │
│  │  (已存在，支持模糊查询)         │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  GET /api/stock/basic-info/all│  │
│  │  (新增，返回所有股票)          │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 3.2 数据流程

#### 3.2.1 登录后数据加载流程
```
用户登录成功
    ↓
调用 GET /api/stock/basic-info/all
    ↓
获取所有股票信息 [{code, name}, ...]
    ↓
保存到 localStorage (key: 'stockBasicInfo')
    ↓
后续搜索优先使用本地缓存
```

#### 3.2.2 搜索流程
```
用户点击搜索按钮
    ↓
显示搜索模态框
    ↓
用户输入关键词
    ↓
防抖处理 (300ms)
    ↓
检查 localStorage 是否有数据
    ├─ 有 → 本地过滤搜索
    └─ 无 → 调用 API /api/stock/list?query=xxx
    ↓
显示搜索结果 (最多20条)
    ↓
用户选择股票
    ↓
跳转到 stock.html?code=xxx&name=xxx
```

### 3.3 数据结构设计

#### 3.3.1 localStorage数据结构
```javascript
// key: 'stockBasicInfo'
// value: Array<{code: string, name: string}>
[
  {code: "000001", name: "平安银行"},
  {code: "000002", name: "万科A"},
  ...
]
```

#### 3.3.2 API响应格式
```json
// GET /api/stock/list
{
  "success": true,
  "data": [
    {"code": "000001", "name": "平安银行"},
    {"code": "000002", "name": "万科A"}
  ],
  "total": 2
}

// GET /api/stock/basic-info/all
{
  "success": true,
  "data": [
    {"code": "000001", "name": "平安银行"},
    ...
  ],
  "total": 5000
}
```

## 4. 接口设计

### 4.1 后端API接口

#### 4.1.1 获取所有股票基本信息
- **接口路径**: `GET /api/stock/basic-info/all`
- **功能描述**: 获取StockBasicInfo表中的所有股票代码和名称
- **请求参数**: 无
- **响应格式**:
```json
{
  "success": true,
  "data": [
    {"code": "000001", "name": "平安银行"},
    {"code": "000002", "name": "万科A"}
  ],
  "total": 5000
}
```
- **错误处理**: 返回500错误和错误信息

#### 4.1.2 股票搜索接口（已存在）
- **接口路径**: `GET /api/stock/list?query={关键词}&limit={数量}`
- **功能描述**: 根据关键词模糊查询股票
- **请求参数**:
  - `query`: 搜索关键词（股票代码或名称）
  - `limit`: 返回结果数量限制（默认15，最大50）
- **响应格式**: 同4.1.1

### 4.2 前端接口调用

#### 4.2.1 加载所有股票信息
```javascript
// 在登录成功后调用
async function loadAllStockInfo() {
  const response = await authFetch(`${API_BASE_URL}/api/stock/basic-info/all`);
  const result = await response.json();
  if (result.success) {
    localStorage.setItem('stockBasicInfo', JSON.stringify(result.data));
  }
}
```

#### 4.2.2 搜索股票
```javascript
// 优先使用本地缓存
function searchStocks(keyword) {
  const cached = localStorage.getItem('stockBasicInfo');
  if (cached) {
    const stocks = JSON.parse(cached);
    return stocks.filter(s => 
      s.code.includes(keyword) || s.name.includes(keyword)
    ).slice(0, 20);
  } else {
    // 降级：调用API
    return fetch(`${API_BASE_URL}/api/stock/list?query=${keyword}&limit=20`);
  }
}
```

## 5. UI/UX设计

### 5.1 搜索模态框设计

#### 5.1.1 布局结构
```
┌─────────────────────────────────────┐
│  输入股票代码或名称              [×] │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐  │
│  │ 🔍 输入股票代码或名称...      │  │
│  └───────────────────────────────┘  │
│                                     │
│  搜索结果：                         │
│  ┌───────────────────────────────┐  │
│  │ 📊 000001 平安银行           │  │
│  ├───────────────────────────────┤  │
│  │ 📊 000002 万科A              │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 5.1.2 样式设计
- 模态框：居中显示，白色背景，圆角8px，阴影
- 输入框：蓝色边框，聚焦时高亮，支持清除按钮
- 搜索结果列表：最大高度400px，支持滚动
- 结果项：hover时高亮，支持键盘导航高亮

### 5.2 交互设计

#### 5.2.1 键盘快捷键
- `Esc`: 关闭搜索模态框
- `↑/↓`: 在搜索结果中导航
- `Enter`: 选择当前高亮的股票或第一个结果
- `Tab`: 切换到下一个元素

#### 5.2.2 鼠标交互
- 点击搜索按钮：显示/隐藏搜索模态框
- 点击遮罩层：关闭搜索模态框
- 点击搜索结果项：跳转到股票详情页
- 鼠标悬停：高亮对应结果项

## 6. 实现细节

### 6.1 防抖处理
```javascript
let searchTimeout;
function handleSearchInput(keyword) {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    performSearch(keyword);
  }, 300);
}
```

### 6.2 本地缓存搜索
```javascript
function searchInCache(keyword) {
  const cached = localStorage.getItem('stockBasicInfo');
  if (!cached) return [];
  
  const stocks = JSON.parse(cached);
  const lowerKeyword = keyword.toLowerCase();
  
  return stocks.filter(stock => 
    String(stock.code).includes(lowerKeyword) ||
    stock.name.toLowerCase().includes(lowerKeyword)
  ).slice(0, 20);
}
```

### 6.3 跳转逻辑
```javascript
function navigateToStock(code, name) {
  const url = `stock.html?code=${code}&name=${encodeURIComponent(name)}`;
  window.location.href = url;
}
```

## 7. 错误处理

### 7.1 网络错误
- API调用失败时显示友好提示
- 如果本地缓存可用，使用缓存数据
- 如果缓存不可用，提示用户稍后重试

### 7.2 数据错误
- 检查localStorage数据格式
- 数据损坏时清除并重新加载
- 搜索结果为空时显示"未找到相关股票"

## 8. 性能优化

### 8.1 缓存策略
- 登录后一次性加载所有股票信息
- 使用localStorage持久化存储
- 搜索时优先使用本地缓存，避免频繁API调用

### 8.2 搜索优化
- 使用防抖减少搜索频率
- 限制搜索结果数量（最多20条）
- 使用虚拟滚动（如果数据量大）

### 8.3 加载优化
- 如果股票数据量过大，考虑分页加载或按需加载
- 使用Web Worker处理大数据量搜索（可选）

## 9. 测试用例

### 9.1 功能测试
1. 测试搜索按钮点击显示模态框
2. 测试输入关键词搜索功能
3. 测试搜索结果点击跳转
4. 测试键盘导航功能
5. 测试登录后数据加载

### 9.2 边界测试
1. 搜索关键词为空
2. 搜索结果为空
3. localStorage数据损坏
4. API调用失败
5. 网络超时

### 9.3 兼容性测试
1. 不同浏览器测试
2. 不同屏幕尺寸测试
3. 移动端适配测试

## 10. 部署说明

### 10.1 前端部署
- 更新 `frontend/components/header.html`
- 更新 `frontend/components/header.js`
- 更新 `frontend/js/login.js`
- 更新相关CSS文件

### 10.2 后端部署
- 新增 `GET /api/stock/basic-info/all` 接口
- 确保StockBasicInfo表有数据
- 测试接口响应时间

## 11. 后续优化建议

1. 支持搜索历史记录
2. 支持热门搜索推荐
3. 支持拼音搜索
4. 支持搜索结果的更多信息展示（如涨跌幅）
5. 支持收藏常用股票快速搜索


