# 港股处理设计文档

## 1. 概述

本文档描述了股票分析系统中港股（香港股票）数据处理的完整设计，包括数据采集端、后端API和前端三个层面的实现。

## 2. 数据采集端设计 (backend_core)

### 2.1 实时行情采集

#### 2.1.1 采集器类
- **文件位置**: `backend_core/data_collectors/akshare/hk_realtime.py`
- **类名**: `HKRealtimeQuoteCollector`
- **继承**: `AKShareCollector`

#### 2.1.2 数据源
- 主要接口: `ak.stock_hk_spot`
- 备用接口: `ak.stock_hk_spot_em`（当主接口失败时使用）
- 采集频率: 工作日 9:05-16:35，每30分钟采集一次

#### 2.1.3 数据库表结构
**表名**: `stock_realtime_quote_hk`

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | String (PK) | 股票代码 |
| trade_date | String (PK) | 交易日期 |
| name | String | 中文名称 |
| english_name | String | 英文名称 |
| current_price | Float | 当前价格 |
| change_percent | Float | 涨跌幅 |
| change_amount | Float | 涨跌额 |
| volume | Float | 成交量 |
| amount | Float | 成交额 |
| high | Float | 最高价 |
| low | Float | 最低价 |
| open | Float | 开盘价 |
| pre_close | Float | 昨收价 |
| update_time | DateTime | 更新时间 |

**表名**: `stock_basic_info_hk`

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | String (PK) | 股票代码 |
| name | String | 股票名称 |
| create_date | DateTime | 创建日期 |

#### 2.1.4 定时任务配置
```python
scheduler.add_job(
    collect_hk_realtime,
    'cron',
    day_of_week='mon-fri',
    hour='9-12,13-16',
    minute='27,57',
    id='hk_realtime',
)
```

### 2.2 历史行情采集

#### 2.2.1 批量历史采集器
- **文件位置**: `backend_core/data_collectors/akshare/hk_historical.py`
- **类名**: `HKHistoricalQuoteCollector`
- **功能**: 从实时行情表同步数据到历史行情表

**采集逻辑**:
1. 从 `stock_realtime_quote_hk` 表读取指定日期的数据
2. 同步到 `historical_quotes_hk` 表
3. 支持多天涨跌幅字段（5天、10天、30天、60天）

**定时任务配置**:
```python
scheduler.add_job(
    collect_hk_historical,
    'cron',
    day_of_week='mon-fri',
    hour=16,
    minute=47,
    id='hk_historical',
)
```

#### 2.2.2 自选股历史采集

**文件位置**: `backend_core/data_collectors/akshare/watchlist_history_collector.py`

**核心函数**:

1. **`is_hk_stock(db: Session, stock_code: str) -> bool`**
   - 功能: 判断股票代码是否为港股
   - 实现: 查询 `stock_basic_info_hk` 表，如果存在则判定为港股
   ```python
   def is_hk_stock(db: Session, stock_code: str) -> bool:
       result = db.execute(
           text("SELECT 1 FROM stock_basic_info_hk WHERE code = :code LIMIT 1"),
           {"code": stock_code}
       ).fetchone()
       return result is not None
   ```

2. **`insert_historical_quotes_hk(db: Session, stock_code: str, df)`**
   - 功能: 批量插入港股历史行情数据
   - 数据源: `ak.stock_hk_hist(symbol=stock_code, period='daily', start_date='19950101', end_date=end_date, adjust='')`
   - 字段映射:
     - 日期格式: YYYYMMDD → YYYY-MM-DD
     - `change_amount` (港股) 对应 `change` (A股)
   - 操作: 使用 PostgreSQL 的 `ON CONFLICT DO UPDATE` 进行 upsert

3. **`collect_watchlist_history()`**
   - 功能: 自选股历史行情采集主函数
   - 处理流程:
     ```
     1. 获取自选股代码列表
     2. 遍历每个代码:
        a. 检查是否已采集过
        b. 判断是否为港股 (调用 is_hk_stock)
        c. 如果是港股:
           - 调用 ak.stock_hk_hist 获取历史数据
           - 删除旧数据
           - 调用 insert_historical_quotes_hk 插入新数据
        d. 如果是A股:
           - 调用 ak.stock_zh_a_hist 获取历史数据
           - 删除旧数据
           - 调用 insert_historical_quotes 插入新数据
        e. 记录采集日志
     ```
   - 定时任务: 每5分钟执行一次

**数据库表结构**:
**表名**: `historical_quotes_hk`

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | String (PK) | 股票代码 |
| date | String (PK) | 日期 (YYYY-MM-DD格式) |
| name | String | 股票名称 |
| english_name | String | 英文名称 |
| open | Float | 开盘价 |
| close | Float | 收盘价 |
| high | Float | 最高价 |
| low | Float | 最低价 |
| pre_close | Float | 昨收价 |
| volume | Float | 成交量 |
| amount | Float | 成交额 |
| change_amount | Float | 涨跌额 |
| change_percent | Float | 涨跌幅 |
| amplitude | Float | 振幅 |
| turnover_rate | Float | 换手率 |
| five_day_change_percent | Float | 5天涨跌% |
| ten_day_change_percent | Float | 10天涨跌% |
| thirty_day_change_percent | Float | 30天涨跌% |
| sixty_day_change_percent | Float | 60天涨跌% |
| collected_source | String | 采集来源 |
| collected_date | DateTime | 采集日期 |

## 3. 后端API设计 (backend_api)

### 3.1 数据模型

#### 3.1.1 SQLAlchemy模型
**文件位置**: `backend_api/models.py`

**模型定义**:
- `StockBasicInfoHK`: 港股基本信息
- `StockRealtimeQuoteHK`: 港股实时行情
- `HistoricalQuotesHK`: 港股历史行情

### 3.2 实时行情API

#### 3.2.1 批量获取股票实时行情
**接口**: `POST /api/stock/quote`

**文件位置**: `backend_api/stock/stock_manage.py`

**处理逻辑**:
1. 优先从 `stock_realtime_quote` (A股表) 查询今日数据
2. 如果A股表没有，从 `stock_realtime_quote_hk` (港股表) 查询
3. 如果数据库都没有，且是工作日，调用 `ak.stock_bid_ask_em` 实时获取
4. 如果API调用失败，从数据库查询最近一次记录（先查A股表，再查港股表）

**返回字段统一**:
- `current_price`: 当前价格
- `change_percent`: 涨跌幅
- `volume`: 成交量
- `turnover`: 成交额
- `high`: 最高价
- `low`: 最低价
- `open`: 开盘价
- `pre_close`: 昨收价

#### 3.2.2 港股排行列表
**接口**: `GET /api/stock/hk_quote_board_list`

**文件位置**: `backend_api/stock/hk_stock_manage.py`

**参数**:
- `ranking_type`: 排行类型 (rise/fall/volume/turnover_rate)
- `page`: 页码
- `page_size`: 每页条数
- `keyword`: 搜索关键词

**数据源**: `stock_realtime_quote_hk` 表

#### 3.2.3 港股指数
**接口**: `GET /api/stock/hk_indices`

**文件位置**: `backend_api/stock/hk_stock_manage.py`

**说明**: 目前返回模拟数据，不调用后端

### 3.3 股票搜索API

#### 3.3.1 股票列表搜索
**接口**: `GET /api/stock/list`

**文件位置**: `backend_api/stock/stock_manage.py`

**处理逻辑**:
1. 先查询 `StockBasicInfo` (A股基础信息表)
2. 如果结果不足，查询 `StockBasicInfoHK` (港股基础信息表)
3. 如果仍不足，从 `StockRealtimeQuoteHK` 表查询（作为后备）
4. 去重返回结果

### 3.4 自选股API

#### 3.4.1 获取自选股列表
**接口**: `GET /api/watchlist`

**文件位置**: `backend_api/watchlist_manage.py`

**处理逻辑**:
1. 获取用户自选股代码列表
2. 对每个代码:
   - 优先从 `StockRealtimeQuote` (A股表) 查询
   - 如果A股表没有，从 `StockRealtimeQuoteHK` (港股表) 查询
3. 字段映射:
   - 港股: `change_amount` 直接使用
   - 港股: `turnover_rate`, `pe_dynamic` 等字段可能为 None
4. 合并结果返回

### 3.5 历史行情API

#### 3.5.1 获取历史行情
**接口**: `GET /api/stock/history`

**文件位置**: `backend_api/stock/history_api.py`

**处理逻辑**:
1. 先查询 `historical_quotes` (A股历史行情表)
2. 如果A股表完全没有数据 (`total == 0`)，查询 `historical_quotes_hk` (港股历史行情表)
3. 字段映射:
   - 港股: `change_amount` → `change`
   - 港股: `cumulative_change_percent` 可能为 NULL
4. 支持分页、日期范围过滤、交易备注关联查询

#### 3.5.2 导出历史行情
**接口**: `GET /api/stock/history/export`

**文件位置**: `backend_api/stock/history_api.py`

**处理逻辑**:
- 与查询接口相同的逻辑（先查A股，再查港股）
- 支持 CSV、Excel、TXT 格式导出
- 字段映射保持一致

#### 3.5.3 计算涨跌功能
**接口**: 
- `POST /api/stock/history/calculate_five_day_change`
- `POST /api/stock/history/calculate_ten_day_change`
- `POST /api/stock/history/calculate_thirty_day_change`
- `POST /api/stock/history/calculate_sixty_day_change`

**文件位置**: `backend_api/stock/history_api.py`

**处理逻辑**:
1. 先查询 `historical_quotes` (A股表)
2. 如果A股表完全没有数据 (`len(quotes) == 0`)，查询 `historical_quotes_hk` (港股表)
3. 根据数据源更新对应的表
4. 计算逻辑与A股相同

### 3.6 A股排行API增强

#### 3.6.1 排行列表
**接口**: `GET /api/stock/quote_board_list`

**文件位置**: `backend_api/stock/stock_manage.py`

**增强功能**:
- 支持 `keyword` 参数，用于搜索股票代码或名称
- 搜索结果在表格中高亮显示，而不是直接跳转到详情页

## 4. 前端设计 (frontend)

### 4.1 行情中心页面

#### 4.1.1 页面结构
**文件位置**: `frontend/markets.html`

**Tab结构**:
- A股标签页: 包含原有所有内容（指数、排行列表）
- 港股标签页: 包含港股指数（模拟）和港股排行列表

#### 4.1.2 A股标签页逻辑
**文件位置**: `frontend/js/markets.js`

**主要功能**:
- `loadRankingData(page, rankingType, keyword)`: 加载排行数据
- `renderRankingTable(data, searchKeyword)`: 渲染表格，支持关键词高亮
- `highlightAndScrollToStock(keyword)`: 高亮并滚动到匹配的股票
- `doSearch()`: 搜索功能，不再直接跳转，而是定位到表格记录

**搜索逻辑改进**:
```javascript
// 修改前: 直接跳转到股票详情页
// 修改后: 刷新表格并高亮匹配记录
doSearch() {
    const query = this.searchInput.value.trim();
    if (query) {
        this.loadRankingData(1, this.currentRankingType, query);
    }
}
```

#### 4.1.3 港股标签页逻辑
**文件位置**: `frontend/js/hk_markets.js`

**主要功能**:
- `loadHKIndices()`: 加载港股指数（模拟数据）
- `loadHKRankingData(page, rankingType, keyword)`: 加载港股排行数据
- `renderHKRankingTable(data, searchKeyword)`: 渲染港股表格
- `searchHKStocks(keyword)`: 搜索港股
- `highlightAndScrollToStock(keyword)`: 高亮并滚动到匹配的股票

**API调用**:
```javascript
// 港股排行数据
fetch(`/api/stock/hk_quote_board_list?ranking_type=${rankingType}&page=${page}&page_size=20&keyword=${keyword || ''}`)

// 港股指数（模拟）
const mockIndices = [
    { name: '恒生指数', value: '18000.00', change: '+1.23%' },
    // ...
];
```

#### 4.1.4 样式设计
**文件位置**: `frontend/css/markets.css`

**新增样式**:
```css
/* Tab样式 */
.market-tabs {
    display: flex;
    border-bottom: 2px solid #e0e0e0;
}

.market-tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
}

.market-tab.active {
    border-bottom-color: #1890ff;
    color: #1890ff;
}

.market-tab-content {
    display: none;
}

.market-tab-content.active {
    display: block;
}

/* 搜索高亮样式 */
.highlight {
    background-color: #fff3cd;
    animation: highlightFade 3s;
}
```

### 4.2 其他页面

#### 4.2.1 自选股页面
- 无需修改，后端API已统一处理A股和港股数据

#### 4.2.2 历史行情页面
- 无需修改，后端API已统一处理A股和港股数据

## 5. 数据流程

### 5.1 实时行情数据流程
```
akshare API (stock_hk_spot)
    ↓
HKRealtimeQuoteCollector.collect_quotes()
    ↓
stock_realtime_quote_hk 表
    ↓
stock_basic_info_hk 表 (更新基本信息)
```

### 5.2 历史行情数据流程

#### 5.2.1 批量历史采集
```
stock_realtime_quote_hk 表
    ↓
HKHistoricalQuoteCollector.collect_historical_quotes()
    ↓
historical_quotes_hk 表
```

#### 5.2.2 自选股历史采集
```
自选股代码列表
    ↓
is_hk_stock() 判断
    ↓
港股: ak.stock_hk_hist() → historical_quotes_hk
A股: ak.stock_zh_a_hist() → historical_quotes
```

### 5.3 API数据查询流程
```
前端请求
    ↓
后端API
    ↓
优先查询A股表
    ↓
A股表有数据? → 返回A股数据
    ↓ 否
查询港股表
    ↓
港股表有数据? → 返回港股数据（字段映射）
    ↓ 否
返回空数据或错误
```

## 6. 关键设计决策

### 6.1 数据源优先级
- **原则**: A股优先，港股补充
- **实现**: 所有API接口先查A股表，A股表完全没有数据时才查港股表
- **原因**: 保持向后兼容，避免影响现有A股功能

### 6.2 字段映射策略
- **港股特有字段**: `change_amount` (涨跌额), `english_name` (英文名称)
- **映射规则**: 
  - `change_amount` → `change` (在API返回时统一)
  - 缺失字段设置为 `None` 或默认值

### 6.3 日期格式处理
- **港股历史表**: 使用 `String` 类型存储日期 (YYYY-MM-DD格式)
- **A股历史表**: 使用 `Date` 类型
- **转换逻辑**: 在数据插入时统一转换为 YYYY-MM-DD 格式

### 6.4 错误处理
- **采集失败**: 记录日志，继续处理下一个股票
- **API查询失败**: 返回空数据或错误信息，不抛出异常
- **数据格式异常**: 使用安全的值转换函数，避免程序崩溃

## 7. 测试建议

### 7.1 单元测试
- `is_hk_stock()` 函数测试
- `insert_historical_quotes_hk()` 函数测试
- 字段映射测试

### 7.2 集成测试
- 自选股历史采集完整流程测试
- API查询A股和港股数据测试
- 前端Tab切换和数据加载测试

### 7.3 数据验证
- 验证港股数据是否正确插入到对应表
- 验证API返回的字段是否正确映射
- 验证前端显示的数据是否与后端一致

## 8. 后续优化建议

### 8.1 性能优化
- 考虑对港股表添加索引
- 优化批量插入性能
- 考虑使用缓存减少数据库查询

### 8.2 功能扩展
- 港股指数真实数据接入
- 港股更多技术指标计算
- 港股新闻和公告采集

### 8.3 代码优化
- 统一A股和港股的代码结构
- 提取公共的数据处理逻辑
- 增强错误处理和日志记录

## 9. 相关文件清单

### 9.1 采集端文件
- `backend_core/data_collectors/akshare/hk_realtime.py`
- `backend_core/data_collectors/akshare/hk_historical.py`
- `backend_core/data_collectors/akshare/watchlist_history_collector.py`
- `backend_core/data_collectors/main.py`

### 9.2 API端文件
- `backend_api/models.py`
- `backend_api/stock/stock_manage.py`
- `backend_api/stock/hk_stock_manage.py`
- `backend_api/stock/history_api.py`
- `backend_api/watchlist_manage.py`
- `backend_api/main.py`

### 9.3 前端文件
- `frontend/markets.html`
- `frontend/js/markets.js`
- `frontend/js/hk_markets.js`
- `frontend/css/markets.css`

### 9.4 测试文件
- `test/test_hk_data_collector.py`

## 10. 版本历史

- **v1.0** (2025-11-20): 初始版本，实现港股数据采集、API查询和前端展示

---

**文档维护**: 本文档应随系统更新而同步更新，确保与实际实现保持一致。

