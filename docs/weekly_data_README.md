# A股周线数据系统文档总览

## 📚 文档导航

本目录包含A股周线数据系统的完整文档，涵盖从需求分析、技术设计到实施部署的全过程。

### 文档列表

| 文档名称 | 说明 | 适用人群 |
|---------|------|---------|
| [快速开始指南](./weekly_data_quickstart.md) | 快速上手，包含环境准备、安装配置、常见问题 | 所有用户 ⭐ |
| [系统设计文档](./weekly_data_design.md) | 详细的技术设计，包含架构、算法、数据库设计 | 开发人员 |
| [API接口文档](./weekly_data_api.md) | API接口规范和前后端调用示例 | 前端/后端开发 |
| [实施总结文档](./weekly_data_implementation.md) | 实施细节和技术要点 | 开发/运维人员 |

## 🎯 推荐阅读路径

### 新手用户
1. **快速开始指南** - 了解系统并快速运行
2. **API接口文档** - 学习如何调用接口
3. **常见问题** - 解决使用中的问题

### 开发人员
1. **系统设计文档** - 理解整体架构和设计思路
2. **实施总结文档** - 了解实现细节
3. **API接口文档** - 实现前后端对接

### 运维人员
1. **快速开始指南** - 部署和配置
2. **系统设计文档** - 了解系统架构
3. **监控与维护** - 日常运维

## 📖 文档概要

### 1. 快速开始指南 (weekly_data_quickstart.md)

**主要内容**:
- ✅ 环境准备和依赖安装
- ✅ 数据库配置
- ✅ 快速开始步骤
- ✅ 使用示例
- ✅ 常见问题解答
- ✅ 性能优化建议

**适合场景**: 
- 首次使用系统
- 需要快速部署
- 遇到问题需要排查

### 2. 系统设计文档 (weekly_data_design.md)

**主要内容**:
- 📋 需求分析（业务需求、功能需求、非功能需求）
- 🏗️ 技术方案（方案选择、技术架构、数据流程）
- 💾 数据库设计（表结构、索引设计）
- 🧮 核心算法（周线聚合、技术指标计算）
- 🔌 接口设计（类接口、命令行接口）
- ⚠️ 异常处理（异常分类、容错机制）
- ⚡ 性能优化（批量处理、查询优化）
- 🧪 测试方案（单元测试、集成测试）
- 🚀 部署方案（环境要求、部署步骤）
- 📊 监控维护（日志监控、数据质量）
- 🔮 扩展性设计（支持其他周期、市场）
- ⚠️ 风险评估

**适合场景**:
- 了解系统整体设计
- 进行二次开发
- 系统架构评审

### 3. API接口文档 (weekly_data_api.md)

**主要内容**:
- 🔌 接口列表和规范
  - 获取股票周线数据
  - 批量获取周线数据
  - 获取最新周线数据
- 💻 后端实现示例（FastAPI）
- 🎨 前端调用示例（JavaScript/Vue）
- 📊 ECharts K线图集成
- ⚡ 性能优化（缓存、分页）
- 🛡️ 安全性考虑（参数验证、SQL注入防护）

**适合场景**:
- 前端开发K线图
- 后端实现API接口
- 系统集成对接

### 4. 实施总结文档 (weekly_data_implementation.md)

**主要内容**:
- ✅ 已完成的工作
- 🔧 技术实现细节
- 📝 使用方法
- ⚠️ 注意事项
- 📋 下一步工作
- 📊 数据表结构

**适合场景**:
- 了解实施进度
- 查看技术要点
- 规划后续工作

## 🚀 系统特性

### 核心优势

1. **自主可控**
   - 基于已有日线数据生成
   - 不依赖外部API
   - 可自定义计算规则

2. **性能优异**
   - 批量处理，高效聚合
   - 支持增量更新
   - 数据库优化

3. **准确可靠**
   - 符合金融行业标准
   - 完整的数据校验
   - 详细的操作日志

4. **易于维护**
   - 代码结构清晰
   - 文档完善
   - 异常处理完善

5. **可扩展性**
   - 支持扩展到月线、季线
   - 支持其他市场（港股、美股）
   - 支持更多技术指标

## 📊 技术栈

| 组件 | 技术 | 版本 |
|-----|------|------|
| 编程语言 | Python | 3.8+ |
| 数据处理 | pandas | 1.3+ |
| 数据库 | PostgreSQL | 12+ |
| ORM | SQLAlchemy | 1.4+ |
| 定时任务 | APScheduler | 3.9+ |
| API框架 | FastAPI | 0.68+ |
| 前端图表 | ECharts | 5.0+ |

## 🔄 数据流程图

```
┌─────────────────┐
│  日线数据表      │
│ historical_quotes│
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  WeeklyDataGenerator    │
│  ┌──────────────────┐   │
│  │ 1. 查询日线数据   │   │
│  │ 2. 时间序列重采样 │   │
│  │ 3. 计算技术指标   │   │
│  │ 4. 保存周线数据   │   │
│  └──────────────────┘   │
└────────┬────────────────┘
         │
         ▼
┌─────────────────┐
│  周线数据表      │
│  weekly_quotes  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   API接口       │
│  /api/quotes/   │
│     weekly/     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  前端展示       │
│  ECharts K线图  │
└─────────────────┘
```

## 📅 定时任务

系统通过定时任务自动更新周线数据：

- **执行时间**: 每周六凌晨 01:00
- **数据范围**: 自动生成过去14天的周线数据
- **任务名称**: `generate_weekly`
- **调度器**: APScheduler

## 💾 数据库表

### weekly_quotes (周线数据表)

| 字段 | 类型 | 说明 |
|-----|------|------|
| code | TEXT | 股票代码 (主键1) |
| date | TEXT | 周线日期 (主键2) |
| open | REAL | 开盘价 |
| high | REAL | 最高价 |
| low | REAL | 最低价 |
| close | REAL | 收盘价 |
| volume | REAL | 成交量 |
| amount | REAL | 成交额 |
| change_percent | REAL | 涨跌幅(%) |
| change | REAL | 涨跌额 |
| amplitude | REAL | 振幅(%) |

## 🔧 核心算法

### 周线聚合规则

```python
weekly_df = df.resample('W-FRI').agg({
    'open': 'first',    # 周开盘 = 本周第一个交易日的开盘价
    'high': 'max',      # 周最高 = 本周最高价
    'low': 'min',       # 周最低 = 本周最低价
    'close': 'last',    # 周收盘 = 本周最后一个交易日的收盘价
    'volume': 'sum',    # 周成交量 = 本周成交量之和
    'amount': 'sum'     # 周成交额 = 本周成交额之和
})
```

### 技术指标计算

- **涨跌幅**: `(本周收盘 - 上周收盘) / 上周收盘 × 100`
- **涨跌额**: `本周收盘 - 上周收盘`
- **振幅**: `(本周最高 - 本周最低) / 上周收盘 × 100`

## 📝 使用示例

### 命令行使用

```bash
# 测试模式（推荐首次使用）
python backend_core/data_collectors/akshare/weekly_collector.py 2025-01-01 2025-11-30 --test

# 生成所有股票的周线数据
python backend_core/data_collectors/akshare/weekly_collector.py 2025-01-01 2025-11-30

# 生成指定股票的周线数据
python backend_core/data_collectors/akshare/weekly_collector.py 2025-01-01 2025-11-30 --stocks 000001 600000
```

### API调用

```javascript
// 获取周线数据
const response = await axios.get('/api/quotes/weekly/000001', {
  params: {
    start_date: '2025-01-01',
    end_date: '2025-11-30'
  }
});

// 绘制K线图
drawWeeklyKLine(response.data.data);
```

### SQL查询

```sql
-- 查询最新20周的数据
SELECT * FROM weekly_quotes 
WHERE code = '000001' 
ORDER BY date DESC 
LIMIT 20;

-- 统计周线数据
SELECT 
    COUNT(DISTINCT code) as stock_count,
    COUNT(*) as total_weeks
FROM weekly_quotes;
```

## ⚠️ 注意事项

1. **数据依赖**: 周线数据依赖日线数据，确保日线数据完整
2. **数据库连接**: 确保PostgreSQL服务运行正常
3. **首次运行**: 建议使用 `--test` 参数测试
4. **性能考虑**: 大量历史数据建议分批生成
5. **数据校验**: 定期检查数据完整性和准确性

## 🐛 常见问题

### 数据库连接失败
- 检查PostgreSQL服务状态
- 验证 `.env` 配置
- 检查网络和防火墙

### 没有生成数据
- 检查日线数据是否存在
- 验证日期范围是否正确
- 查看日志文件排查错误

### 涨跌幅为NULL
- 第一周数据无法计算涨跌幅（正常现象）
- 查询时可以过滤掉NULL值

详细解决方案请参考 [快速开始指南](./weekly_data_quickstart.md#常见问题)

## 📞 技术支持

遇到问题时的排查步骤：

1. 📋 查看日志文件 `weekly_generation.log`
2. 🔍 检查数据库连接和数据
3. 📚 参考相关文档
4. 🐛 提交Issue（如果是系统bug）

## 🔄 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0.0 | 2025-11-30 | 初始版本，实现基于日线数据生成周线功能 |

## 📜 许可证

本项目为内部使用项目，未对外开源。

---

**最后更新**: 2025-11-30  
**维护者**: 股票分析系统开发团队
