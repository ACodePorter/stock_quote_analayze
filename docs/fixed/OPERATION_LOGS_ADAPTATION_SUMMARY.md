# operation_logs 表适配总结

## 问题描述

用户要求保持 `operation_logs` 表的现有结构不变，而是修改前端界面显示内容和后台代码逻辑来适配现有的表结构。

## 解决方案

### 1. 后端适配

#### 字段映射系统
- 添加了 `get_field_mapping()` 函数来适配不同的表结构
- 支持多种字段名映射：
  - `operation_type` ↔ `log_type`
  - `operation_desc` ↔ `log_message`
  - `affected_rows` ↔ `affected_count`
  - `status` ↔ `log_status`
  - `error_message` ↔ `error_info`
  - `created_at` ↔ `log_time`

#### 修改的文件
- `backend_api/admin/logs.py`

#### 主要修改点
1. **字段映射函数**：
   ```python
   def get_field_mapping(table_config: Dict[str, Any]) -> Dict[str, str]:
       """获取字段映射，适配不同的表结构"""
   ```

2. **查询逻辑适配**：
   - 使用字段映射构建WHERE条件
   - 动态生成ORDER BY子句
   - 适配不同的字段名进行筛选

3. **统计逻辑适配**：
   - 使用字段映射进行状态统计
   - 适配不同的日期字段进行时间范围查询
   - 支持不同字段名的操作类型统计

### 2. 前端适配

#### 动态字段映射
- 添加了 `getFieldMapping()` 方法来适配不同表结构
- 支持四种日志表的字段映射：
  - `operation`: 使用 `log_type`, `log_message` 等字段
  - `historical_collect`: 使用标准字段名
  - `realtime_collect`: 使用标准字段名
  - `watchlist_history`: 特殊处理，显示股票代码

#### 动态表头
- 添加了 `updateTableHeaders()` 方法来动态更新表头
- 根据当前标签页显示不同的列标题：
  - 系统操作日志：`日志类型`, `日志消息`, `影响数量`, `日志状态`, `错误信息`, `日志时间`
  - 自选股历史采集日志：`股票代码`, `操作描述`, `影响行数`, `状态`, `错误信息`, `创建时间`
  - 其他日志：`操作类型`, `操作描述`, `影响行数`, `状态`, `错误信息`, `创建时间`

#### 修改的文件
- `admin/js/logs.js`

#### 主要修改点
1. **字段映射方法**：
   ```javascript
   getFieldMapping(tableKey) {
       const mappings = {
           'operation': {
               'operation_type': 'log_type',
               'operation_desc': 'log_message',
               // ...
           }
       };
   }
   ```

2. **动态表头更新**：
   ```javascript
   updateTableHeaders() {
       // 根据当前标签页更新表头
   }
   ```

3. **数据渲染适配**：
   ```javascript
   renderLogsTable(data) {
       // 使用字段映射渲染数据
   }
   ```

## 适配效果

### 1. 系统操作日志标签页
- **表头**: ID, 日志类型, 日志消息, 影响数量, 日志状态, 错误信息, 日志时间
- **字段映射**: 
  - `log_type` → 日志类型
  - `log_message` → 日志消息
  - `affected_count` → 影响数量
  - `log_status` → 日志状态
  - `error_info` → 错误信息
  - `log_time` → 日志时间

### 2. 其他日志标签页
- **表头**: ID, 操作类型, 操作描述, 影响行数, 状态, 错误信息, 创建时间
- **字段映射**: 使用标准字段名

### 3. 自选股历史采集日志标签页
- **表头**: ID, 股票代码, 操作描述, 影响行数, 状态, 错误信息, 创建时间
- **特殊处理**: 显示股票代码而不是操作类型

## 测试验证

### 测试脚本
- `test_operation_logs_adapted.py` - 验证适配后的功能

### 验证要点
1. **API响应正常**: 不再出现500错误
2. **字段映射正确**: 数据正确显示
3. **表头动态更新**: 切换标签页时表头正确更新
4. **筛选功能正常**: 支持按不同字段筛选
5. **统计功能正常**: 统计信息正确计算

## 兼容性说明

### 向后兼容
- 保持原有API接口不变
- 支持现有的表结构
- 不影响其他日志表的功能

### 扩展性
- 字段映射系统易于扩展
- 支持添加新的表结构
- 前端可以轻松适配新的字段名

## 总结

通过实现字段映射系统和动态表头更新，成功适配了 `operation_logs` 表的现有结构，无需修改数据库表结构。系统现在可以：

1. **自动识别字段名**: 根据表结构自动映射字段
2. **动态显示内容**: 根据日志类型显示不同的列标题
3. **保持功能完整**: 所有查询、筛选、统计功能正常工作
4. **易于维护**: 字段映射集中管理，便于后续维护

这种方案既满足了用户保持表结构不变的要求，又确保了系统的正常运行和良好的用户体验。 