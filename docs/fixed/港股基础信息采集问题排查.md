# 港股基础信息采集问题排查

## 问题描述

`stock_basic_info_hk` 表应该采集到2700多只港股，但今天只采集到59条数据。

## 问题原因

### 1. 接口数据量限制

通过测试发现：
- `ak.stock_hk_spot()` 接口只返回了 **59条数据**（这是接口本身的限制）
- `ak.stock_hk_spot_em()` 接口应该返回更多数据（2000+条），但调用时出现网络连接错误

### 2. 字段名检查逻辑错误

原代码中使用了错误的字段名检查方式：
```python
if 'symbol' in row.index:  # 错误：row.index 是行索引，不是列名
    code = str(row['symbol']).strip()
```

应该使用：
```python
if 'symbol' in df.columns:  # 正确：检查DataFrame的列名
    code = str(row.get('symbol')).strip()
```

### 3. 接口调用顺序问题

原代码优先使用 `stock_hk_spot`（只返回59条），失败后才使用 `stock_hk_spot_em`（返回更多数据）。

## 解决方案

### 1. 修复字段名检查逻辑

已修复 `backend_core/data_collectors/akshare/hk_realtime.py` 中的字段名检查逻辑：

```python
# 修复前（错误）
if 'symbol' in row.index:
    code = str(row['symbol']).strip()

# 修复后（正确）
for field_name in ['代码', '股票代码', 'symbol', 'code']:
    if field_name in df.columns:
        val = row.get(field_name)
        if val is not None and pd.notna(val):
            code = str(val).strip()
            if code:
                break
```

### 2. 改进接口调用顺序

优先使用 `stock_hk_spot_em`（数据更全），失败后再使用 `stock_hk_spot`：

```python
# 先尝试调用 stock_hk_spot_em（东方财富接口，数据更全）
try:
    df = self._retry_on_failure(ak.stock_hk_spot_em)
    source_name = "stock_hk_spot_em"
except Exception as e1:
    # 如果失败，再尝试 stock_hk_spot
    df = self._retry_on_failure(ak.stock_hk_spot)
    source_name = "stock_hk_spot"
```

### 3. 添加数据量检查

添加了数据量检查，如果数据量异常偏少会记录警告：

```python
# 检查数据量是否正常（港股应该有2000+只股票）
if data_count < 1000:
    self.logger.warning(f"警告：港股实时行情数据量异常偏少（{data_count}条），正常应该有2000+条。可能是接口限制或数据源问题。")
```

## 测试结果

运行测试脚本 `test/test_hk_spot_fields.py` 的结果：

```
stock_hk_spot 接口：
- 数据行数: 59
- 数据列名: ['symbol', 'name', 'engname', 'tradetype', 'lasttrade', 'prevclose', 'open', 'high', 'low', 'volume', 'amount', 'ticktime', 'buy', 'sell', 'pricechange', 'changepercent']

stock_hk_spot_em 接口：
- 调用失败（网络连接错误）
```

## 后续建议

1. **监控数据量**：在采集完成后检查数据量，如果少于1000条，记录警告并通知管理员。

2. **重试机制**：对于 `stock_hk_spot_em` 接口的网络错误，可以增加重试次数和延迟时间。

3. **备用数据源**：考虑使用其他接口或数据源来获取完整的港股列表，例如：
   - `ak.stock_hk_info()` - 港股基本信息
   - 其他第三方数据源

4. **定期全量更新**：可以定期（如每周）使用 `stock_hk_spot_em` 接口进行一次全量更新，确保基础信息表的完整性。

## 相关文件

- `backend_core/data_collectors/akshare/hk_realtime.py` - 港股实时行情采集器（已修复）
- `test/test_hk_spot_fields.py` - 测试脚本（用于检查接口返回的字段名）

## 修复日期

2025-12-11

