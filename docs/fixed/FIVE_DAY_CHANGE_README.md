# 5天升跌值计算功能使用说明

## 📖 功能概述

5天升跌值计算功能是一个自动化的技术指标计算工具，用于计算股票历史数据的5天升跌百分比。该功能为投资决策提供重要的技术分析数据支持。

## 🎯 核心特性

- **自动计算**：支持单只股票和批量计算
- **实时监控**：提供计算状态和进度监控
- **数据验证**：内置计算结果的准确性验证
- **性能优化**：支持大规模数据的批量处理
- **用户友好**：提供直观的Web界面和API接口

## 🏗️ 系统架构

### 后端架构
```
backend_api/
├── trading_notes_routes.py          # 主要API接口
├── services/
│   └── five_day_change_calculator.py # 计算服务
└── models.py                        # 数据模型
```

### 数据库架构
```
historical_quotes表
├── code                            # 股票代码
├── date                            # 交易日期
├── close                           # 收盘价
├── five_day_change_percent         # 5天升跌%（新增字段）
└── ...                            # 其他字段
```

### 前端界面
```
frontend/
└── five_day_change_calculator.html # 计算器Web界面
```

## 🚀 快速开始

### 1. 环境准备

确保您的系统已安装：
- Python 3.8+
- PostgreSQL 12+
- 必要的Python依赖包

### 2. 数据库配置

执行数据库扩展脚本：
```bash
# 连接到PostgreSQL数据库
psql -U your_username -d your_database

# 执行SQL脚本
\i database/add_five_day_change_field.sql
```

### 3. 启动后端服务

```bash
cd backend_api
python main.py
```

### 4. 访问Web界面

在浏览器中打开：
```
http://localhost:8000/frontend/five_day_change_calculator.html
```

## 📊 使用方法

### Web界面操作

#### 单只股票计算
1. 在"单只股票计算"区域输入股票代码（如：000001）
2. 点击"计算单只股票"按钮
3. 等待计算完成，查看结果

#### 批量计算
1. 在"批量计算"区域点击"开始批量计算"按钮
2. 监控进度条显示计算进度
3. 计算完成后查看统计结果

#### 状态监控
1. 切换到"状态监控"标签页
2. 点击"刷新状态"查看整体计算进度
3. 输入股票代码查询单只股票的计算状态

### API接口调用

#### 计算单只股票
```bash
POST /api/trading_notes/{stock_code}/calculate_five_day_change
```

**请求示例：**
```bash
curl -X POST "http://localhost:8000/api/trading_notes/000001/calculate_five_day_change"
```

**响应示例：**
```json
{
    "message": "股票 000001 的5天升跌%计算完成"
}
```

#### 批量计算所有股票
```bash
POST /api/trading_notes/calculate_all_five_day_change
```

**请求示例：**
```bash
curl -X POST "http://localhost:8000/api/trading_notes/calculate_all_five_day_change"
```

**响应示例：**
```json
{
    "message": "批量计算完成，成功: 150, 失败: 2"
}
```

## 🧮 计算逻辑

### 计算公式
```
5天升跌% = (当前收盘价 - 5天前收盘价) / 5天前收盘价 × 100
```

### 计算规则
- **时间跨度**：5个交易日（不是自然日）
- **起始点**：从第6个交易日开始计算
- **基准价格**：5天前的收盘价
- **当前价格**：当日的收盘价
- **精度**：保留2位小数

### 计算示例
假设股票000001的历史数据：
- 2025-01-20：收盘价 7.18
- 2025-01-21：收盘价 7.20
- 2025-01-22：收盘价 7.18
- 2025-01-23：收盘价 7.20
- 2025-01-24：收盘价 7.25

计算2025-01-24的5天升跌%：
```
5天升跌% = (7.25 - 7.18) / 7.18 × 100 = 0.97%
```

## 🔧 配置选项

### 环境变量
```bash
# 数据库连接
DATABASE_URL=postgresql://username:password@localhost:5432/database_name

# API服务配置
API_HOST=0.0.0.0
API_PORT=8000

# 日志级别
LOG_LEVEL=INFO
```

### 计算参数
```python
# 在 five_day_change_calculator.py 中可以调整的参数
TRADING_DAYS = 5          # 计算天数
DECIMAL_PLACES = 2        # 小数位数
BATCH_SIZE = 100          # 批量处理大小
```

## 📈 性能优化

### 数据库优化
- 在 `(code, date)` 上建立复合索引
- 使用批量更新而不是逐条更新
- 考虑分区表以提高查询性能

### 计算优化
- 增量计算：只计算新增或修改的数据
- 并行计算：多线程处理不同股票
- 缓存机制：缓存计算结果

### 调度优化
- 避开交易时间，在收盘后进行批量计算
- 使用队列系统处理大量计算任务
- 监控计算性能，及时调整策略

## 🧪 测试验证

### 运行测试脚本
```bash
python test_five_day_change_calculation.py
```

### 测试内容
- API连接测试
- 单只股票计算测试
- 批量计算测试
- 数据验证测试
- 性能测试

### 验证方法
1. **手动验证**：对比手动计算的结果
2. **数据一致性**：检查计算结果的准确性
3. **边界条件**：测试数据不足5天的情况
4. **异常处理**：测试网络错误和数据库异常

## 📝 日志监控

### 日志级别
- **INFO**：一般信息，如计算开始、完成
- **SUCCESS**：成功操作
- **WARNING**：警告信息
- **ERROR**：错误信息

### 日志内容
- 计算开始和完成时间
- 处理的股票数量和记录数
- 成功和失败的数量统计
- 错误详情和异常信息

### 日志导出
- 支持导出为文本文件
- 日志文件命名：`five_day_change_logs_YYYY-MM-DD.txt`
- 自动限制日志数量，避免内存占用过大

## 🚨 故障排除

### 常见问题

#### 1. 计算失败
**症状**：API返回500错误
**解决方案**：
- 检查数据库连接
- 验证数据完整性
- 查看错误日志

#### 2. 数据不完整
**症状**：某些股票的5天升跌%为空
**解决方案**：
- 检查历史数据是否足够5天
- 验证收盘价数据是否有效
- 重新运行计算

#### 3. 性能问题
**症状**：批量计算耗时过长
**解决方案**：
- 优化数据库索引
- 调整批量处理大小
- 使用并行计算

### 调试方法
1. **查看日志**：检查操作日志和系统日志
2. **数据库查询**：直接查询数据库验证数据
3. **API测试**：使用Postman或curl测试API接口
4. **性能分析**：监控CPU、内存和数据库性能

## 🔮 未来扩展

### 功能扩展
1. **可配置周期**：支持3天、7天、10天等不同周期
2. **技术指标**：基于5天升跌%计算其他技术指标
3. **预警系统**：当5天升跌%超过阈值时发出预警
4. **可视化图表**：提供5天升跌%的趋势图表

### 技术升级
1. **实时计算**：支持实时数据更新后的自动计算
2. **分布式计算**：支持多服务器并行计算
3. **机器学习**：基于历史数据预测5天升跌趋势
4. **API增强**：提供更多查询和计算接口

## 📞 技术支持

### 联系方式
- **开发团队**：股票分析软件开发组
- **邮箱**：support@stockanalyze.com
- **文档**：查看项目文档目录

### 反馈建议
如果您在使用过程中遇到问题或有改进建议，请：
1. 查看本文档的故障排除部分
2. 检查系统日志获取详细错误信息
3. 联系技术支持团队

## 📄 许可证

本项目采用MIT许可证，详情请查看LICENSE文件。

---

**最后更新**：2025年1月
**版本**：v1.0.0
**维护者**：股票分析软件开发团队
