# æ•°æ®é‡‡é›†APIæœåŠ¡ä¸ç®¡ç†ç«¯é¡µé¢ä½¿ç”¨è¯´æ˜

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»æ•°æ®é‡‡é›†ç¨‹åºçš„APIæœåŠ¡å°è£…å’Œç®¡ç†ç«¯é¡µé¢åŠŸèƒ½ï¼Œå®ç°äº†ä»å‘½ä»¤è¡Œå·¥å…·åˆ°WebæœåŠ¡çš„å®Œæ•´è¿ç§»ã€‚

## ğŸ“‹ ç³»ç»Ÿæ¶æ„

### 1. åç«¯APIæœåŠ¡
- **ä½ç½®**: `backend_api/stock/data_collection_api.py`
- **åŠŸèƒ½**: æä¾›RESTful APIæ¥å£
- **æŠ€æœ¯æ ˆ**: FastAPI + SQLAlchemy + Background Tasks

### 2. ç®¡ç†ç«¯é¡µé¢
- **ä½ç½®**: `admin/datacollect.html`
- **åŠŸèƒ½**: æä¾›Webç•Œé¢æ“ä½œ
- **æŠ€æœ¯æ ˆ**: Vue.js + Element Plus + Tailwind CSS

### 3. æ•°æ®é‡‡é›†æ ¸å¿ƒ
- **ä½ç½®**: `backend_core/data_collectors/akshare/historical_collector.py`
- **åŠŸèƒ½**: å®é™…çš„æ•°æ®é‡‡é›†é€»è¾‘
- **æŠ€æœ¯æ ˆ**: akshare + pandas + SQLAlchemy

## ğŸš€ APIæ¥å£è¯´æ˜

### 1. å¯åŠ¨å†å²æ•°æ®é‡‡é›†

**æ¥å£**: `POST /data-collection/historical`

**è¯·æ±‚å‚æ•°**:
```json
{
    "start_date": "2025-08-01",
    "end_date": "2025-09-03",
    "stock_codes": ["000001", "000002"],  // å¯é€‰
    "test_mode": false  // å¯é€‰
}
```

**å“åº”**:
```json
{
    "task_id": "historical_collection_20250904_143022_12345",
    "status": "started",
    "message": "å†å²æ•°æ®é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨",
    "start_date": "2025-08-01",
    "end_date": "2025-09-03",
    "stock_codes": null,
    "test_mode": false
}
```

### 2. è·å–ä»»åŠ¡çŠ¶æ€

**æ¥å£**: `GET /data-collection/status/{task_id}`

**å“åº”**:
```json
{
    "task_id": "historical_collection_20250904_143022_12345",
    "status": "running",
    "progress": 45,
    "total_stocks": 100,
    "processed_stocks": 45,
    "success_count": 43,
    "failed_count": 2,
    "collected_count": 1250,
    "skipped_count": 0,
    "start_time": "2025-09-04T14:30:22",
    "end_time": null,
    "error_message": null,
    "failed_details": []
}
```

### 3. è·å–ä»»åŠ¡åˆ—è¡¨

**æ¥å£**: `GET /data-collection/tasks`

**å“åº”**:
```json
[
    {
        "task_id": "historical_collection_20250904_143022_12345",
        "status": "completed",
        "progress": 100,
        "total_stocks": 100,
        "processed_stocks": 100,
        "success_count": 98,
        "failed_count": 2,
        "collected_count": 2500,
        "skipped_count": 0,
        "start_time": "2025-09-04T14:30:22",
        "end_time": "2025-09-04T14:35:15",
        "error_message": null,
        "failed_details": []
    }
]
```

### 4. å–æ¶ˆä»»åŠ¡

**æ¥å£**: `DELETE /data-collection/tasks/{task_id}`

**å“åº”**:
```json
{
    "message": "ä»»åŠ¡å·²å–æ¶ˆ",
    "task_id": "historical_collection_20250904_143022_12345"
}
```

### 5. è·å–è‚¡ç¥¨åˆ—è¡¨

**æ¥å£**: `GET /data-collection/stock-list`

**å“åº”**:
```json
{
    "total": 5417,
    "stocks": [
        {
            "code": "000001",
            "name": "å¹³å®‰é“¶è¡Œ"
        },
        {
            "code": "000002",
            "name": "ä¸‡ç§‘A"
        }
    ]
}
```

## ğŸ–¥ï¸ ç®¡ç†ç«¯é¡µé¢åŠŸèƒ½

### 1. é¡µé¢ç‰¹æ€§
- âœ… å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
- âœ… å®æ—¶ä»»åŠ¡çŠ¶æ€æ›´æ–°
- âœ… è¿›åº¦æ¡æ˜¾ç¤º
- âœ… ä»»åŠ¡å–æ¶ˆåŠŸèƒ½
- âœ… é”™è¯¯ä¿¡æ¯å±•ç¤º
- âœ… è¡¨å•éªŒè¯

### 2. ä¸»è¦åŠŸèƒ½æ¨¡å—

#### 2.1 é‡‡é›†é…ç½®
- **æ—¥æœŸèŒƒå›´é€‰æ‹©**: å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ
- **è‚¡ç¥¨é€‰æ‹©**: æ”¯æŒé‡‡é›†æ‰€æœ‰è‚¡ç¥¨æˆ–æŒ‡å®šè‚¡ç¥¨ä»£ç 
- **æµ‹è¯•æ¨¡å¼**: åªé‡‡é›†å‰5åªè‚¡ç¥¨è¿›è¡Œæµ‹è¯•
- **è¡¨å•éªŒè¯**: ç¡®ä¿è¾“å…¥æ•°æ®æœ‰æ•ˆæ€§

#### 2.2 ä»»åŠ¡ç®¡ç†
- **ä»»åŠ¡åˆ—è¡¨**: æ˜¾ç¤ºæ‰€æœ‰é‡‡é›†ä»»åŠ¡
- **çŠ¶æ€æ˜¾ç¤º**: è¿è¡Œä¸­ã€å·²å®Œæˆã€å¤±è´¥ã€å·²å–æ¶ˆ
- **è¿›åº¦ç›‘æ§**: å®æ—¶æ˜¾ç¤ºä»»åŠ¡è¿›åº¦
- **ç»Ÿè®¡ä¿¡æ¯**: æˆåŠŸæ•°ã€å¤±è´¥æ•°ã€æ–°å¢æ•°æ®é‡
- **ä»»åŠ¡å–æ¶ˆ**: æ”¯æŒå–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

#### 2.3 å®æ—¶æ›´æ–°
- **è‡ªåŠ¨åˆ·æ–°**: æ¯5ç§’è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡çŠ¶æ€
- **å®æ—¶è¿›åº¦**: åŠ¨æ€æ›´æ–°è¿›åº¦æ¡
- **çŠ¶æ€å˜åŒ–**: åŠæ—¶åæ˜ ä»»åŠ¡çŠ¶æ€å˜åŒ–

## ğŸ”§ éƒ¨ç½²å’Œä½¿ç”¨

### 1. å¯åŠ¨APIæœåŠ¡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd stock_quote_analayze

# å¯åŠ¨APIæœåŠ¡
python backend_api/main.py
```

### 2. è®¿é—®ç®¡ç†ç«¯é¡µé¢

```
http://localhost:8000/admin/datacollect.html
```

### 3. æµ‹è¯•APIæœåŠ¡

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python test/test_data_collection_api.py
```

## ğŸ“Š ä½¿ç”¨æµç¨‹

### 1. åŸºæœ¬ä½¿ç”¨æµç¨‹

1. **æ‰“å¼€ç®¡ç†ç«¯é¡µé¢**
   - è®¿é—® `http://localhost:8000/admin/datacollect.html`

2. **é…ç½®é‡‡é›†å‚æ•°**
   - é€‰æ‹©æ—¥æœŸèŒƒå›´
   - é€‰æ‹©è‚¡ç¥¨èŒƒå›´ï¼ˆå…¨éƒ¨æˆ–æŒ‡å®šï¼‰
   - å¯é€‰æ‹©æµ‹è¯•æ¨¡å¼

3. **å¯åŠ¨é‡‡é›†ä»»åŠ¡**
   - ç‚¹å‡»"å¼€å§‹é‡‡é›†"æŒ‰é’®
   - ç³»ç»Ÿä¼šè¿”å›ä»»åŠ¡ID

4. **ç›‘æ§ä»»åŠ¡è¿›åº¦**
   - é¡µé¢ä¼šè‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€
   - æŸ¥çœ‹è¿›åº¦æ¡å’Œç»Ÿè®¡ä¿¡æ¯

5. **æŸ¥çœ‹ç»“æœ**
   - ä»»åŠ¡å®ŒæˆåæŸ¥çœ‹é‡‡é›†ç»“æœ
   - å¦‚æœ‰å¤±è´¥å¯æŸ¥çœ‹é”™è¯¯è¯¦æƒ…

### 2. é«˜çº§åŠŸèƒ½

#### 2.1 æ‰¹é‡é‡‡é›†
```javascript
// é€šè¿‡APIæ‰¹é‡å¯åŠ¨å¤šä¸ªä»»åŠ¡
const tasks = [
    { start_date: "2025-08-01", end_date: "2025-08-31" },
    { start_date: "2025-09-01", end_date: "2025-09-30" }
];

for (const task of tasks) {
    await axios.post('/data-collection/historical', task);
}
```

#### 2.2 ä»»åŠ¡ç›‘æ§
```javascript
// ç›‘æ§ç‰¹å®šä»»åŠ¡
const taskId = "historical_collection_20250904_143022_12345";
const status = await axios.get(`/data-collection/status/${taskId}`);
console.log(`ä»»åŠ¡è¿›åº¦: ${status.data.progress}%`);
```

## âš™ï¸ é…ç½®è¯´æ˜

### 1. APIé…ç½®

**æ–‡ä»¶**: `backend_api/main.py`

```python
# æ³¨å†Œæ•°æ®é‡‡é›†è·¯ç”±
from stock.data_collection_api import router as data_collection_router
app.include_router(data_collection_router)
```

### 2. æ•°æ®åº“é…ç½®

**æ–‡ä»¶**: `backend_api/database.py`

ç¡®ä¿æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®ï¼Œæ”¯æŒPostgreSQLã€‚

### 3. æ—¥å¿—é…ç½®

**æ–‡ä»¶**: `backend_api/stock/data_collection_api.py`

```python
logger = logging.getLogger(__name__)
```

## ğŸ” æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

#### 1.1 APIæœåŠ¡æ— æ³•å¯åŠ¨
- æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
- ç¡®è®¤ä¾èµ–åŒ…å·²å®‰è£…
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

#### 1.2 æ•°æ®åº“è¿æ¥å¤±è´¥
- æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€
- ç¡®è®¤è¿æ¥é…ç½®æ­£ç¡®
- éªŒè¯æ•°æ®åº“æƒé™

#### 1.3 é‡‡é›†ä»»åŠ¡å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤akshareå¯ç”¨æ€§
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

### 2. è°ƒè¯•æ–¹æ³•

#### 2.1 æŸ¥çœ‹APIæ—¥å¿—
```bash
tail -f app.log
```

#### 2.2 æµ‹è¯•APIç«¯ç‚¹
```bash
curl http://localhost:8000/data-collection/stock-list
```

#### 2.3 æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
```bash
curl http://localhost:8000/data-collection/tasks
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘æ§åˆ¶
- ä½¿ç”¨åå°ä»»åŠ¡é¿å…é˜»å¡
- åˆç†è®¾ç½®è¯·æ±‚é—´éš”
- æ”¯æŒä»»åŠ¡å–æ¶ˆ

### 2. å†…å­˜ç®¡ç†
- åŠæ—¶é‡Šæ”¾æ•°æ®åº“è¿æ¥
- é¿å…å¤§é‡æ•°æ®åŠ è½½åˆ°å†…å­˜
- ä½¿ç”¨æµå¼å¤„ç†

### 3. é”™è¯¯å¤„ç†
- å®Œå–„çš„å¼‚å¸¸æ•è·
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- ä¼˜é›…çš„å¤±è´¥å¤„ç†

## ğŸ”® æ‰©å±•åŠŸèƒ½

### 1. è®¡åˆ’ä»»åŠ¡
- æ”¯æŒå®šæ—¶é‡‡é›†
- å‘¨æœŸæ€§æ•°æ®æ›´æ–°
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

### 2. æ•°æ®æºæ‰©å±•
- æ”¯æŒæ›´å¤šæ•°æ®æº
- æ•°æ®æºåˆ‡æ¢åŠŸèƒ½
- æ•°æ®è´¨é‡æ£€æŸ¥

### 3. ç›‘æ§å‘Šè­¦
- ä»»åŠ¡å¤±è´¥å‘Šè­¦
- æ€§èƒ½ç›‘æ§
- èµ„æºä½¿ç”¨ç»Ÿè®¡

---

**ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025-09-04  
**é€‚ç”¨ç¯å¢ƒ**: Python 3.7+, FastAPI, Vue.js
