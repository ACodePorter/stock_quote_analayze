# 历史数据导出功能

<cite>
**本文档引用文件**   
- [history_api.py](file://backend_api/stock/history_api.py)
- [trading_notes_routes.py](file://backend_api/trading_notes_routes.py)
- [models.py](file://backend_api/models.py)
- [stock_history.js](file://frontend/js/stock_history.js)
</cite>

## 目录
1. [接口概述](#接口概述)
2. [include_notes参数控制逻辑](#include_notes参数控制逻辑)
3. BOM头解决Excel中文乱码问题
4. 动态CSV头生成机制
5. StreamingResponse流式响应实现
6. 备注数据双重验证机制
7. 文件名生成与Content-Disposition设置
8. 异常处理流程
9. 前端交互逻辑

## 接口概述

`export_stock_history`接口提供股票历史数据的CSV文件导出功能，支持根据`include_notes`参数动态决定是否包含交易备注字段。该接口位于`backend_api/stock/history_api.py`文件中，通过GET请求方式暴露，能够处理指定股票代码、日期范围和备注包含选项的导出请求。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L139-L165)

## include_notes参数控制逻辑

`include_notes`参数作为查询参数接收布尔值，决定导出数据是否包含交易备注信息。当参数为`True`时，系统执行包含`trading_notes`表的LEFT JOIN查询；当为`False`时，仅查询基础历史行情数据。

接口根据`include_notes`参数选择不同的SQL查询语句：
- 包含备注：关联`trading_notes`表，获取用户备注、策略类型和风险等级等信息
- 不包含备注：仅从`historical_quotes`表获取基础行情数据

这种设计实现了灵活的数据导出策略，允许用户根据需求选择导出内容的详细程度。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L139-L165)

## BOM头解决Excel中文乱码问题

为解决Excel打开UTF-8编码CSV文件时出现中文乱码的问题，系统在生成CSV内容时添加了BOM（Byte Order Mark）头`\ufeff`。这一特殊字符位于文件开头，用于标识文件采用UTF-8编码，使Excel能够正确识别并正确显示中文字符。

```python
# 添加BOM头，解决Excel打开中文乱码问题
output.write('\ufeff')
```

此解决方案无需改变文件的实际编码，仅通过添加标识符即可确保Excel正确解析中文内容，是处理中文CSV文件兼容性的标准做法。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L223-L225)

## 动态CSV头生成机制

系统实现了智能的CSV表头生成逻辑，根据实际数据情况动态选择表头内容。该机制包含双重判断：

1. 首先检查`include_notes`参数是否请求包含备注
2. 然后验证是否存在实际的备注数据

当且仅当`include_notes=True`且确实存在备注数据时，使用包含"用户备注"、"策略类型"、"风险等级"的完整表头；否则使用简化表头，将最后一列标记为"备注"。

```python
if include_notes and has_notes_data:
    headers = ["股票代码", "股票名称", "日期", "开盘", "收盘", "最高", "最低",
               "成交量", "成交额", "涨跌幅%", "涨跌额", "换手率%",
               "累计升跌%", "5天升跌%", "10天升跌%", "60天升跌%", 
               "用户备注", "策略类型", "风险等级"]
else:
    headers = ["股票代码", "股票名称", "日期", "开盘", "收盘", "最高", "最低",
               "成交量", "成交额", "涨跌幅%", "涨跌额", "换手率%",
               "累计升跌%", "5天升跌%", "10天升跌%", "60天升跌%", "备注"]
```

这种动态机制避免了在没有实际备注数据时显示空的备注列，提升了用户体验。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L223-L251)

## StreamingResponse流式响应实现

为避免大文件导出时的内存溢出问题，系统采用`StreamingResponse`实现流式响应。该机制将CSV数据作为生成器逐块传输，而不是一次性加载到内存中。

```python
return StreamingResponse(
    iter([output.getvalue()]),
    media_type="text/csv; charset=utf-8",
    headers={"Content-Disposition": f"attachment; filename*=UTF-8''{filename}"}
)
```

尽管当前实现将整个CSV内容放入内存缓冲区，但`StreamingResponse`的使用为未来优化提供了基础架构。理想情况下，可以将大型数据集分批处理并逐块流式传输，从而显著降低内存占用。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L279-L285)

## 备注数据双重验证机制

系统实施了严谨的双重验证机制来确定是否包含备注相关字段，确保数据一致性：

1. **表存在性检查**：首先查询`information_schema.tables`确认`trading_notes`表是否存在
2. **数据存在性检查**：在表存在的情况下，检查特定股票代码是否有非空的用户备注记录

```python
# 检查trading_notes表是否存在
table_check_query = """
    SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name = 'trading_notes'
    );
"""
table_exists = db.execute(text(table_check_query)).scalar()

if table_exists:
    # 检查是否有任何备注数据
    notes_check_query = """
        SELECT COUNT(*) FROM trading_notes 
        WHERE stock_code = :code 
        AND (user_notes IS NOT NULL AND user_notes != '')
    """
    notes_count = db.execute(text(notes_check_query), {"code": code}).scalar()
    has_notes_data = notes_count > 0
```

这种双重验证防止了因表不存在或数据为空而导致的错误，提高了系统的健壮性。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L192-L225)

## 文件名生成与Content-Disposition设置

系统采用规范的文件名生成策略和HTTP头设置，确保下载文件的可识别性和正确处理：

```python
filename = f"{code}_historical_quotes_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"

return StreamingResponse(
    iter([output.getvalue()]),
    media_type="text/csv; charset=utf-8",
    headers={"Content-Disposition": f"attachment; filename*=UTF-8''{filename}"}
)
```

文件名包含：
- 股票代码
- 固定标识"historical_quotes"
- 当前时间戳（精确到秒）
- .csv扩展名

`Content-Disposition`头使用`filename*=UTF-8''`语法，明确指定文件名的字符编码，确保浏览器正确处理包含中文或特殊字符的文件名。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L279-L285)

## 异常处理流程

系统实现了分层的异常处理机制，确保导出操作的稳定性和用户友好的错误反馈：

1. **数据未找到异常**：当查询结果为空时，抛出404状态码的`HTTPException`
2. **已知业务异常**：直接重新抛出`HTTPException`，保持原始错误信息
3. **未知异常**：捕获所有其他异常，记录错误日志，并返回500状态码的通用错误信息

```python
try:
    # 主要业务逻辑
    ...
except HTTPException:
    raise
except Exception as e:
    error_msg = f"导出失败: {str(e)}"
    print(f"[export_stock_history] {error_msg}")
    raise HTTPException(status_code=500, detail=error_msg)
```

这种异常处理策略既保证了关键错误的准确传递，又防止了系统内部细节泄露给客户端，同时提供了足够的日志信息用于问题排查。

**Section sources**
- [history_api.py](file://backend_api/stock/history_api.py#L279-L320)

## 前端交互逻辑

前端通过`stock_history.js`中的`exportHistory`方法与后端接口交互，实现了完整的导出功能：

1. 验证用户登录状态
2. 收集导出参数（股票代码、日期范围、是否包含备注）
3. 发起带认证的导出请求
4. 处理响应并触发浏览器下载

```javascript
async exportHistory() {
    const userInfo = CommonUtils.auth.getUserInfo();
    if (!userInfo || !userInfo.id) {
        CommonUtils.showToast('请先登录后再导出数据', 'warning');
        window.location.href = 'login.html';
        return;
    }
    
    const url = `${API_BASE_URL}/api/stock/history/export?code=${this.currentStockCode}&start_date=${startDate}&end_date=${endDate}&include_notes=${includeNotes}`;
    
    const response = await authFetch(url);
    if (!response.ok) {
        if (response.status === 401) {
            CommonUtils.showToast('登录已过期，请重新登录', 'error');
            CommonUtils.auth.logout();
            return;
        }
        throw new Error(`导出失败: ${response.status}`);
    }
    
    // 创建下载链接并触发下载
    const blob = await response.blob();
    const downloadUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `${this.currentStockCode}_历史行情_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(downloadUrl);
}
```

前端还实现了错误处理、登录状态验证和用户体验优化，确保导出功能的可靠性和易用性。

**Section sources**
- [stock_history.js](file://frontend/js/stock_history.js#L348-L434)