# 数据库配置

<cite>
**本文档中引用的文件**   
- [deploy_config.json](file://deploy_config.json)
- [生产环境说明.md](file://生产环境说明.md)
- [backend_api/config.py](file://backend_api/config.py)
- [backend_api/database.py](file://backend_api/database.py)
- [backend_core/config/config.py](file://backend_core/config/config.py)
- [backend_core/database/db.py](file://backend_core/database/db.py)
</cite>

## 目录
1. [数据库连接参数](#数据库连接参数)
2. [连接池配置](#连接池配置)
3. [备份策略](#备份策略)
4. [生产环境数据库服务器信息](#生产环境数据库服务器信息)
5. [数据库连接失败排查方法](#数据库连接失败排查方法)
6. [安全建议](#安全建议)
7. [代码示例：配置读取与使用](#代码示例配置读取与使用)

## 数据库连接参数

根据 `deploy_config.json` 文件中的配置，PostgreSQL数据库的连接参数如下：

- **主机地址 (host)**: 192.168.31.237
- **端口 (port)**: 5446
- **数据库名称 (name)**: stock_analysis
- **用户名 (user)**: postgres
- **密码 (password)**: qidianspacetime

在 `backend_api/config.py` 文件中，这些参数被组合成一个完整的连接URL，用于SQLAlchemy数据库引擎的初始化。连接URL的格式为 `postgresql+psycopg2://用户:密码@主机:端口/数据库名`。

**Section sources**
- [deploy_config.json](file://deploy_config.json#L8-L14)
- [backend_api/config.py](file://backend_api/config.py#L15-L20)

## 连接池配置

数据库连接池用于管理数据库连接的复用，提高性能并防止连接耗尽。根据 `deploy_config.json` 文件，连接池配置如下：

- **pool_size**: 5，表示连接池中保持的最小连接数（空闲或在使用中）。
- **max_overflow**: 10，表示当连接池中的连接全部被占用时，可以额外创建的最大连接数。

这些配置在 `backend_api/database.py` 和 `backend_core/database/db.py` 中被传递给SQLAlchemy的 `create_engine` 函数，用于创建数据库引擎实例。

**Section sources**
- [deploy_config.json](file://deploy_config.json#L15-L16)
- [backend_api/database.py](file://backend_api/database.py#L14-L18)
- [backend_core/database/db.py](file://backend_core/database/db.py#L10-L18)

## 备份策略

系统的备份策略由 `deploy_config.json` 文件中的 `backup_enabled` 和 `backup_interval` 参数定义：

- **backup_enabled**: true，表示数据库备份功能已启用。
- **backup_interval**: daily，表示备份的频率为每日一次。

此策略确保了数据库数据的定期备份，以防止数据丢失。

**Section sources**
- [deploy_config.json](file://deploy_config.json#L17-L18)

## 生产环境数据库服务器信息

根据 `生产环境说明.md` 文件，生产环境中实际运行的数据库服务器信息与开发/部署配置文件中的信息存在差异。生产环境信息如下：

- **服务器IP**: 192.168.16.4
- **数据库端口**: 5432
- **数据库名称**: stock_analysis
- **用户名**: postgres
- **密码**: qidianspacetime$91
- **连接URL**: `postgresql+psycopg2://postgres:qidianspacetime$91@192.168.16.4:5432/stock_analysis`

**重要提示**: `deploy_config.json` 中的配置（如IP地址192.168.31.237和端口5446）可能用于开发或测试环境。在生产环境中，应用程序应连接到IP为192.168.16.4、端口为5432的数据库服务器。这种差异通常通过环境变量或不同的配置文件来管理。

```mermaid
graph TB
subgraph "应用服务"
BackendAPI[后端API<br>192.168.16.4:5000]
BackendCore[数据采集模块<br>192.168.16.4]
end
subgraph "数据库服务"
PostgreSQL[(PostgreSQL<br>192.168.16.4:5432<br>数据库: stock_analysis)]
end
BackendAPI --> PostgreSQL
BackendCore --> PostgreSQL
style BackendAPI fill:#99ff99,stroke:#333
style BackendCore fill:#99ff99,stroke:#333
style PostgreSQL fill:#ffcc99,stroke:#333
```

**Diagram sources **
- [生产环境说明.md](file://生产环境说明.md#L4-L10)
- [系统部署架构图.md](file://系统部署架构图.md#L4-L65)

## 数据库连接失败排查方法

当应用程序无法连接到数据库时，可按以下步骤进行排查：

### 1. 网络不通
- **现象**: 连接超时或“无法连接到服务器”错误。
- **排查方法**:
    - 使用 `ping 192.168.16.4` 命令检查网络连通性。
    - 使用 `telnet 192.168.16.4 5432` 或 `nc -zv 192.168.16.4 5432` 命令检查目标端口是否开放。
    - 确认防火墙（Windows防火墙或云服务器安全组）是否放行了5432端口。

### 2. 认证失败
- **现象**: “密码认证失败”或“用户不存在”错误。
- **排查方法**:
    - 核对 `生产环境说明.md` 中提供的用户名和密码是否正确。
    - 检查数据库中是否存在 `postgres` 用户，并确认其密码。
    - 确保连接字符串中的密码没有被错误地转义或包含多余字符。

### 3. 端口冲突或服务未启动
- **现象**: 连接被拒绝。
- **排查方法**:
    - 登录数据库服务器，检查PostgreSQL服务是否正在运行。
    - 使用 `netstat -an | findstr 5432` (Windows) 或 `netstat -tlnp | grep 5432` (Linux) 命令，确认PostgreSQL进程正在监听5432端口。
    - 检查 `生产环境说明.md` 中提到的数据库目录 `C:\Program Files\PostgreSQL\17\data` 是否存在，确认安装路径正确。

**Section sources**
- [生产环境说明.md](file://生产环境说明.md#L4-L10)
- [生产环境说明.md](file://生产环境说明.md#L82-L85)

## 安全建议

为了保障数据库的安全，建议遵循以下最佳实践：

- **密码复杂度要求**: 数据库密码应包含大小写字母、数字和特殊字符，长度不少于12位。生产环境的密码 `qidianspacetime$91` 符合此要求，而开发环境的密码 `qidianspacetime` 较弱，应避免在生产中使用。
- **连接字符串加密存储**: 避免在代码中硬编码数据库密码。应使用环境变量（如 `.env` 文件）或密钥管理服务来存储敏感信息。`env_example.txt` 文件展示了使用环境变量的示例。
- **最小权限原则**: 为应用程序创建专用的数据库用户，仅授予其执行必要操作（如SELECT, INSERT, UPDATE, DELETE）的权限，避免使用超级用户（如postgres）进行日常连接。

**Section sources**
- [env_example.txt](file://env_example.txt#L27-L33)
- [生产环境说明.md](file://生产环境说明.md#L5-L6)

## 代码示例：配置读取与使用

以下代码示例说明了 `backend_api` 和 `backend_core` 模块如何读取和使用数据库配置。

### backend_api 模块

在 `backend_api` 中，数据库配置被硬编码在 `config.py` 文件的 `DATABASE_CONFIG` 字典中。`database.py` 文件导入此配置并创建SQLAlchemy引擎。

```mermaid
classDiagram
class config {
+dict DATABASE_CONFIG
}
class database {
+Engine engine
+SessionLocal SessionLocal
+get_db() Generator[Session]
}
config --> database : "导入"
database ..> "SQLAlchemy" : "使用"
```

**Diagram sources **
- [backend_api/config.py](file://backend_api/config.py#L15-L20)
- [backend_api/database.py](file://backend_api/database.py#L14-L18)

### backend_core 模块

在 `backend_core` 中，虽然 `config.py` 文件主要配置了数据采集器，但数据库连接信息被直接硬编码在 `database/db.py` 文件的 `DATABASE_URL` 常量中。该模块同样使用SQLAlchemy来管理数据库会话。

```mermaid
classDiagram
class db {
+str DATABASE_URL
+Engine engine
+SessionLocal SessionLocal
+get_db() Generator[Session]
}
db ..> "SQLAlchemy" : "使用"
```

**Diagram sources **
- [backend_core/database/db.py](file://backend_core/database/db.py#L5-L10)