# 服务管理

<cite>
**本文档引用文件**  
- [start_production_services.bat](file://start_production_services.bat)
- [fix_production_issue.bat](file://fix_production_issue.bat)
- [start_backend_api.py](file://start_backend_api.py)
- [start_frontend.py](file://start_frontend.py)
- [nginx_complete.conf](file://nginx_complete.conf)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本文档详细说明了股票分析系统在生产环境下的服务管理操作流程。基于 `start_production_services.bat` 和 `fix_production_issue.bat` 脚本，全面阐述了前端、后端API、管理后台及Nginx反向代理服务的启动、检查与修复机制。文档涵盖服务依赖顺序、端口状态验证、进程控制命令以及Windows平台下的最佳实践，确保运维人员能够高效、安全地维护系统运行。

## 项目结构
本项目采用微服务架构，包含多个独立运行的服务模块，通过Nginx统一对外提供HTTPS访问。各服务分别位于不同目录，通过批处理脚本集中管理。

```mermaid
graph TB
subgraph "服务模块"
Frontend[前端服务<br>端口: 8000]
BackendAPI[后端API服务<br>端口: 5000]
Admin[管理后台服务<br>端口: 8001]
Nginx[Nginx反向代理<br>端口: 80/443]
end
subgraph "控制脚本"
StartScript[start_production_services.bat]
FixScript[fix_production_issue.bat]
end
StartScript --> Frontend
StartScript --> BackendAPI
StartScript --> Admin
StartScript --> Nginx
FixScript --> Frontend
FixScript --> BackendAPI
FixScript --> Admin
FixScript --> Nginx
```

**图示来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)
- [fix_production_issue.bat](file://fix_production_issue.bat#L1-L95)

**本节来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)
- [fix_production_issue.bat](file://fix_production_issue.bat#L1-L95)

## 核心组件
系统由四个核心服务组成：前端应用、后端API、管理后台和Nginx反向代理。`start_production_services.bat` 脚本按依赖顺序依次启动这些服务，而 `fix_production_issue.bat` 脚本则用于检测并修复异常服务。Nginx作为入口网关，将外部请求路由至对应内部服务。

**本节来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)
- [fix_production_issue.bat](file://fix_production_issue.bat#L1-L95)

## 架构概览
系统采用典型的前后端分离架构，Nginx作为反向代理服务器统一对外暴露HTTPS服务，并将请求转发至内部不同端口的服务。各服务之间无直接调用，全部通过Nginx进行流量调度。

```mermaid
graph LR
Client[客户端] --> Nginx["Nginx (443/80)<br>反向代理"]
Nginx --> |/ → /| Frontend["前端服务 (8000)<br>Python HTTP Server"]
Nginx --> |/api/ → /api/| BackendAPI["后端API (5000)<br>FastAPI + Uvicorn"]
Nginx --> |/admin/ → /| Admin["管理后台 (8001)<br>Python -m http.server"]
subgraph "内部服务"
Frontend
BackendAPI
Admin
end
```

**图示来源**  
- [nginx_complete.conf](file://nginx_complete.conf#L1-L240)
- [start_production_services.bat](file://start_production_services.bat#L1-L35)

## 详细组件分析

### 启动脚本分析
`start_production_services.bat` 是系统主启动脚本，负责按顺序启动所有服务。脚本通过 `start` 命令在新窗口中运行各服务，并使用 `timeout` 命令设置5秒延迟，确保服务有足够时间初始化。

#### 启动流程图
```mermaid
flowchart TD
Start([启动脚本]) --> Step1["1. 启动后端API服务<br>cd /d backend_api<br>start python start_backend_api.py"]
Step1 --> Wait1["timeout /t 5"]
Step1 --> Step2["2. 启动前端服务<br>cd /d frontend<br>start python start_frontend.py"]
Step2 --> Wait2["timeout /t 5"]
Step2 --> Step3["3. 启动管理后台<br>cd /d admin-modern<br>start python -m http.server 8001"]
Step3 --> Wait3["timeout /t 5"]
Step3 --> Step4["4. 启动Nginx<br>cd /d nginx-1.28.0<br>start nginx.exe"]
Step4 --> End([所有服务启动完成])
```

**图示来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)

**本节来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)

### 修复脚本分析
`fix_production_issue.bat` 是生产环境故障修复脚本，通过 `netstat` 检查关键端口状态，并自动重启异常服务。该脚本可用于日常巡检或服务异常后的快速恢复。

#### 修复流程图
```mermaid
flowchart TD
Start([修复脚本]) --> Check8000["检查8000端口"]
Check8000 --> Port8000OK{端口正常?}
Port8000OK --> |否| StartFrontend["启动前端服务"]
Port8000OK --> |是| Check5000["检查5000端口"]
StartFrontend --> Wait1["等待3秒"]
Wait1 --> Check5000
Check5000 --> Port5000OK{端口正常?}
Port5000OK --> |否| StartBackend["启动后端API"]
Port5000OK --> |是| Check8001["检查8001端口"]
StartBackend --> Wait2["等待3秒"]
Wait2 --> Check8001
Check8001 --> Port8001OK{端口正常?}
Port8001OK --> |否| StartAdmin["启动管理后台"]
Port8001OK --> |是| Check80["检查80端口"]
StartAdmin --> Wait3["等待3秒"]
Wait3 --> Check80
Check80 --> Port80OK{端口正常?}
Port80OK --> |否| StartNginx["启动Nginx"]
Port80OK --> |是| Check443["检查443端口"]
StartNginx --> Wait4["等待3秒"]
Wait4 --> Check443
Check443 --> FinalCheck["最终状态检查"]
FinalCheck --> End([修复完成])
```

**图示来源**  
- [fix_production_issue.bat](file://fix_production_issue.bat#L1-L95)

**本节来源**  
- [fix_production_issue.bat](file://fix_production_issue.bat#L1-L95)

### 后端API服务分析
后端API服务由 `start_backend_api.py` 脚本启动，基于FastAPI框架并通过Uvicorn服务器运行。服务监听5000端口，支持热重载功能，便于开发调试。

```mermaid
classDiagram
class UvicornServer {
+run(app, host, port, reload, log_level)
}
class FastAPIApp {
+app : FastAPI
+routes : /api/*
}
class StartScript {
+main()
+print_startup_info()
}
StartScript --> UvicornServer : "调用"
UvicornServer --> FastAPIApp : "运行"
```

**图示来源**  
- [start_backend_api.py](file://start_backend_api.py#L1-L32)

**本节来源**  
- [start_backend_api.py](file://start_backend_api.py#L1-L32)

### 前端服务分析
前端服务由 `start_frontend.py` 脚本启动，内置HTTP服务器并支持自定义路由处理。脚本会自动查找8000起始的可用端口，处理根路径重定向，并添加必要的CORS头。

#### 前端服务启动序列
```mermaid
sequenceDiagram
participant Script as start_frontend.py
participant Handler as CustomHTTPRequestHandler
participant Server as HTTPServer
participant Browser as Web浏览器
Script->>Script : main()
Script->>Script : find_available_port(8000)
Script->>Server : start_server(port)
Server->>Handler : 初始化处理器
Handler->>Handler : 设置directory="frontend"
Server->>Server : serve_forever()
Script->>Browser : webbrowser.open(login.html)
Browser->>Server : GET /login.html
Server->>Handler : 处理请求
Handler-->>Browser : 返回HTML内容
```

**图示来源**  
- [start_frontend.py](file://start_frontend.py#L1-L90)

**本节来源**  
- [start_frontend.py](file://start_frontend.py#L1-L90)

### Nginx配置分析
`nginx_complete.conf` 文件定义了完整的反向代理规则，包括HTTP到HTTPS重定向、API代理、静态资源缓存及Vue Router的history模式支持。

#### Nginx请求处理流程
```mermaid
flowchart TD
Request[客户端请求] --> HTTPCheck{是否HTTPS?}
HTTPCheck --> |否| Redirect["301重定向到HTTPS"]
HTTPCheck --> |是| PathCheck["路径匹配"]
PathCheck --> |/api/*| ProxyAPI["代理到127.0.0.1:5000"]
PathCheck --> |/admin/*| ProxyAdmin["代理到127.0.0.1:8001"]
PathCheck --> |/assets/*| CacheAssets["缓存1年"]
PathCheck --> |其他| ProxyFrontend["代理到127.0.0.1:8000"]
ProxyAdmin --> |404| FallbackAdmin["返回/admin/index.html"]
ProxyFrontend --> |404| FallbackFrontend["返回/index.html"]
ProxyAPI --> BackendAPI
ProxyAdmin --> Admin
ProxyFrontend --> Frontend
```

**图示来源**  
- [nginx_complete.conf](file://nginx_complete.conf#L1-L240)

**本节来源**  
- [nginx_complete.conf](file://nginx_complete.conf#L1-L240)

## 依赖关系分析
系统各服务存在明确的启动依赖关系：后端API需先于前端启动，Nginx必须在所有后端服务就绪后启动。Nginx作为唯一对外暴露的服务，依赖于内部所有服务的正常运行。

```mermaid
graph TD
BackendAPI[后端API服务] --> Nginx
Frontend[前端服务] --> Nginx
Admin[管理后台服务] --> Nginx
Nginx --> Client[客户端]
style BackendAPI fill:#f9f,stroke:#333
style Frontend fill:#bbf,stroke:#333
style Admin fill:#f96,stroke:#333
style Nginx fill:#9f9,stroke:#333
```

**图示来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)
- [nginx_complete.conf](file://nginx_complete.conf#L1-L240)

**本节来源**  
- [start_production_services.bat](file://start_production_services.bat#L1-L35)
- [nginx_complete.conf](file://nginx_complete.conf#L1-L240)

## 性能考虑
- **端口检查延迟**：`fix_production_issue.bat` 中使用 `timeout /t 3` 确保服务有足够时间响应，避免频繁重启。
- **静态资源缓存**：Nginx配置对 `/assets/` 和 `/favicon.ico` 启用1年缓存，提升前端性能。
- **连接超时设置**：Nginx代理设置30秒超时，防止后端服务响应缓慢影响整体性能。
- **进程隔离**：各服务在独立窗口运行，便于监控和故障隔离。

## 故障排查指南
当服务异常时，可按以下步骤排查：

1. **检查端口占用**：
   ```cmd
   netstat -ano | findstr :5000
   ```
   若端口被占用，使用以下命令终止进程：
   ```cmd
   tasklist | findstr :5000
   taskkill /PID <进程ID> /F
   ```

2. **验证服务状态**：
   访问健康检查端点：
   ```
   https://www.icemaplecity.com/health
   ```

3. **查看Nginx日志**：
   检查 `logs/access.log` 和 `logs/error.log` 获取详细错误信息。

4. **手动重启服务**：
   若自动修复失败，可手动执行 `start_production_services.bat`。

**本节来源**  
- [fix_production_issue.bat](file://fix_production_issue.bat#L1-L95)
- [nginx_complete.conf](file://nginx_complete.conf#L1-L240)

## 结论
本文档详细解析了股票分析系统的服务管理机制。通过标准化的批处理脚本，实现了服务的自动化启动与故障修复。Nginx作为统一入口，有效整合了多个微服务。建议运维人员熟悉各脚本逻辑，并定期执行健康检查，确保系统稳定运行。