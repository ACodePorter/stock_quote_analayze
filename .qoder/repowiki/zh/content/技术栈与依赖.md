# 技术栈与依赖

<cite>
**本文档中引用的文件**  
- [package.json](file://admin/package.json)
- [vite.config.ts](file://admin/vite.config.ts)
- [tailwind.config.js](file://admin/tailwind.config.js)
- [main.ts](file://admin/src/main.ts)
- [auth.ts](file://admin/src/stores/auth.ts)
- [api.ts](file://admin/src/services/api.ts)
- [requirements.txt](file://backend_api/requirements.txt)
- [main.py](file://backend_api/main.py)
- [database.py](file://backend_api/database.py)
- [models.py](file://backend_api/models.py)
- [requirements.txt](file://backend_core/requirements.txt)
- [main.py](file://backend_core/data_collectors/akshare/main.py)
- [main.py](file://backend_core/data_collectors/tushare/main.py)
- [historical_quotes.py](file://backend_core/models/historical_quotes.py)
- [db.py](file://backend_core/database/db.py)
- [requirements.txt](file://requirements.txt)
</cite>

## 目录
1. [前端技术栈](#前端技术栈)
2. [后端技术栈](#后端技术栈)
3. [机器学习与数据分析](#机器学习与数据分析)
4. [数据库与ORM](#数据库与orm)
5. [依赖清单](#依赖清单)
6. [环境搭建指南](#环境搭建指南)

## 前端技术栈

前端部分位于 `admin` 目录，采用现代化的 Vue 3 生态系统，结合 TypeScript 提供类型安全，使用 Vite 作为构建工具以提升开发效率。UI 组件库选用 Element Plus，样式框架采用 Tailwind CSS，并通过 Pinia 进行状态管理。

### Vue 3 与 TypeScript

项目基于 Vue 3 的组合式 API 构建，使用 `createApp` 初始化应用，并通过 `defineStore` 创建模块化状态管理。TypeScript 提供了完整的类型定义，确保代码的可维护性和健壮性。

```mermaid
classDiagram
class App {
+createApp()
}
class Pinia {
+createPinia()
+defineStore()
}
class VueRouter {
+createRouter()
+createWebHistory()
}
App --> Pinia : "集成"
App --> VueRouter : "集成"
```

**Diagram sources**  
- [main.ts](file://admin/src/main.ts#L1-L22)

**Section sources**  
- [main.ts](file://admin/src/main.ts#L1-L22)
- [package.json](file://admin/package.json#L15-L18)

### Vite 构建工具

Vite 配置文件 `vite.config.ts` 定义了开发服务器代理、生产环境基础路径、构建输出目录等关键设置。开发服务器代理将 `/api` 请求转发至后端服务（`http://localhost:5000`），实现前后端分离开发。

```mermaid
flowchart TD
A["开发服务器 (http://localhost:8001)"] --> B["/api 请求"]
B --> C["反向代理"]
C --> D["后端API (http://localhost:5000)"]
E["静态资源"] --> F["dist/"]
G["别名 @"] --> H["src/"]
```

**Diagram sources**  
- [vite.config.ts](file://admin/vite.config.ts#L1-L48)

**Section sources**  
- [vite.config.ts](file://admin/vite.config.ts#L1-L48)

### Element Plus UI 组件库

Element Plus 被作为全局插件注册，所有组件均可直接使用。项目还集成了 `@element-plus/icons-vue` 图标库，并在 `main.ts` 中批量注册所有图标组件，便于在模板中直接调用。

```mermaid
flowchart LR
A["main.ts"] --> B["app.use(ElementPlus)"]
A --> C["注册所有图标"]
C --> D["ElementPlusIconsVue"]
B --> E["全局可用组件"]
D --> E
```

**Diagram sources**  
- [main.ts](file://admin/src/main.ts#L1-L22)

**Section sources**  
- [main.ts](file://admin/src/main.ts#L1-L22)
- [package.json](file://admin/package.json#L15-L16)

### Pinia 状态管理

Pinia 用于管理用户认证状态（`auth.ts`），包括 token、用户信息、加载状态和错误信息。通过 `localStorage` 持久化存储认证信息，并在应用初始化时自动恢复状态。

```mermaid
classDiagram
class useAuthStore {
+token : string
+user : UserInfo
+loading : boolean
+error : string
+isAuthenticated : boolean
+login(credentials)
+logout()
+initAuth()
}
class localStorage {
+getItem(key)
+setItem(key, value)
+removeItem(key)
}
useAuthStore --> localStorage : "持久化"
```

**Diagram sources**  
- [auth.ts](file://admin/src/stores/auth.ts#L1-L118)

**Section sources**  
- [auth.ts](file://admin/src/stores/auth.ts#L1-L118)

### Tailwind CSS 样式框架

Tailwind CSS 配置文件 `tailwind.config.js` 定义了自定义颜色主题（primary、gray）、字体族、间距和动画效果。通过 `corePlugins.preflight: false` 禁用默认样式重置，避免与 Element Plus 样式冲突。

```mermaid
flowchart TD
A["tailwind.config.js"] --> B["自定义主题"]
B --> C["颜色: primary, gray"]
B --> D["字体: Inter"]
B --> E["间距: 18, 88"]
B --> F["动画: fade-in, slide-up"]
A --> G["content 配置"]
G --> H["扫描 src/**/*.{vue,js,ts}"]
A --> I["禁用preflight"]
I --> J["避免与Element Plus冲突"]
```

**Diagram sources**  
- [tailwind.config.js](file://admin/tailwind.config.js#L1-L61)

**Section sources**  
- [tailwind.config.js](file://admin/tailwind.config.js#L1-L61)

## 后端技术栈

后端采用 FastAPI 框架构建高性能 API 服务，结合 SQLAlchemy 进行数据库操作，使用 Pydantic 定义数据模型和验证规则。

### FastAPI Web 框架

`main.py` 是 FastAPI 应用的入口文件，定义了应用实例、CORS 配置、路由注册和启动事件。支持跨域请求，允许来自本地开发环境和生产域名的访问。

```mermaid
flowchart TD
A["FastAPI App"] --> B["CORS 中间件"]
B --> C["允许来源: localhost, icemaplecity.com"]
A --> D["请求日志中间件"]
A --> E["路由注册"]
E --> F["auth_routes"]
E --> G["admin/*"]
E --> H["stock/*"]
E --> I["watchlist_manage"]
A --> J["启动事件"]
J --> K["初始化数据库"]
```

**Diagram sources**  
- [main.py](file://backend_api/main.py#L1-L128)

**Section sources**  
- [main.py](file://backend_api/main.py#L1-L128)

### SQLAlchemy ORM

`database.py` 文件配置了 SQLAlchemy 引擎和会话工厂，使用连接池优化数据库性能。`get_db` 函数通过依赖注入为 FastAPI 路由提供数据库会话。

```mermaid
classDiagram
class DatabaseConfig {
+url : str
+pool_size : int
+max_overflow : int
+echo : bool
}
class Engine {
+create_engine()
}
class SessionLocal {
+sessionmaker()
}
class get_db() {
+Generator[Session, None, None]
}
DatabaseConfig --> Engine : "配置"
Engine --> SessionLocal : "绑定"
SessionLocal --> get_db : "生成会话"
```

**Diagram sources**  
- [database.py](file://backend_api/database.py#L1-L71)

**Section sources**  
- [database.py](file://backend_api/database.py#L1-L71)

### Pydantic 数据模型

`models.py` 文件中定义了 SQLAlchemy 模型和 Pydantic 模型。Pydantic 模型用于 API 请求/响应的数据验证和序列化，如 `UserCreate`、`Token`、`QuoteDataCreate` 等。

```mermaid
classDiagram
class UserBase {
+username : str
+email : EmailStr
}
class UserCreate {
+password : str
+role : Optional[str]
}
class UserInDB {
+id : int
+created_at : datetime
+last_login : Optional[datetime]
}
class Token {
+access_token : str
+token_type : str
+user : Optional[UserInDB]
}
UserCreate --|> UserBase : "继承"
UserInDB --|> UserBase : "继承"
Token --> UserInDB : "可选引用"
```

**Diagram sources**  
- [models.py](file://backend_api/models.py#L1-L434)

**Section sources**  
- [models.py](file://backend_api/models.py#L1-L434)

## 机器学习与数据分析

`backend_core` 模块专注于数据采集、分析和机器学习任务，集成了多种数据源和算法库。

### 数据采集器

项目支持 AkShare 和 Tushare 两大金融数据源，分别通过独立的采集器实现。每个采集器支持实时行情、历史行情和指数行情的采集。

```mermaid
flowchart TD
A["数据采集入口"] --> B["AKShare"]
A --> C["Tushare"]
B --> D["实时行情"]
B --> E["历史行情"]
B --> F["指数行情"]
C --> G["实时行情"]
C --> H["历史行情"]
C --> I["指数行情"]
C --> J["文件导入"]
D --> K["AkshareRealtimeQuoteCollector"]
E --> L["HistoricalQuoteCollector"]
F --> M["IndexQuoteCollector"]
G --> N["RealtimeQuoteCollector"]
H --> O["HistoricalQuoteCollector"]
I --> P["IndexQuoteCollector"]
J --> Q["HistoricalQuoteImportFromFileCollector"]
```

**Diagram sources**  
- [main.py](file://backend_core/data_collectors/akshare/main.py#L1-L71)
- [main.py](file://backend_core/data_collectors/tushare/main.py#L1-L36)

**Section sources**  
- [main.py](file://backend_core/data_collectors/akshare/main.py#L1-L71)
- [main.py](file://backend_core/data_collectors/tushare/main.py#L1-L36)

### 机器学习库

`backend_core/requirements.txt` 列出了完整的机器学习依赖，包括：
- **Scikit-learn**：基础机器学习算法
- **XGBoost**：梯度提升决策树
- **LightGBM**：轻量级梯度提升框架
- **CatBoost**：类别特征优化的梯度提升
- **TensorFlow**：深度学习框架
- **PyTorch**：动态计算图深度学习框架
- **Transformers**：预训练语言模型库

这些库为股票价格预测、趋势分析、风险评估等高级功能提供支持。

```mermaid
flowchart LR
A["机器学习"] --> B["Scikit-learn"]
A --> C["XGBoost"]
A --> D["LightGBM"]
A --> E["CatBoost"]
A --> F["TensorFlow"]
A --> G["PyTorch"]
A --> H["Transformers"]
B --> I["分类/回归"]
C --> J["高性能GBDT"]
F --> K["神经网络"]
G --> L["动态图"]
H --> M["NLP模型"]
```

**Section sources**  
- [requirements.txt](file://backend_core/requirements.txt#L15-L22)

## 数据库与ORM

项目使用 PostgreSQL 作为主数据库，通过 SQLAlchemy ORM 进行对象关系映射。

### PostgreSQL 配置

`backend_core/database/db.py` 文件中定义了 PostgreSQL 连接字符串和引擎配置，使用 `psycopg2` 作为驱动。

```python
DATABASE_URL = "postgresql+psycopg2://postgres:qidianspacetime@localhost:5446/stock_analysis"
```

连接池配置包括：
- `pool_size=10`：基础连接数
- `max_overflow=20`：最大溢出连接数
- `pool_pre_ping=True`：连接前健康检查
- `pool_recycle=3600`：连接回收周期

```mermaid
classDiagram
class DatabaseConfig {
+DATABASE_URL : str
+pool_size : 10
+max_overflow : 20
+pool_pre_ping : True
+pool_recycle : 3600
}
class Engine {
+create_engine()
}
class SessionLocal {
+sessionmaker()
}
DatabaseConfig --> Engine : "配置"
Engine --> SessionLocal : "绑定"
```

**Diagram sources**  
- [db.py](file://backend_core/database/db.py#L1-L32)

**Section sources**  
- [db.py](file://backend_core/database/db.py#L1-L32)

### ORM 模型定义

`backend_core/models/historical_quotes.py` 定义了历史行情数据的 ORM 模型，继承自 `Base`，映射到 `historical_quotes` 表。

```mermaid
classDiagram
class HistoricalQuotes {
+code : String [PK]
+ts_code : String
+name : String
+market : String
+date : Date [PK]
+open : Float
+close : Float
+high : Float
+low : Float
+volume : Integer
+amount : Float
+change_percent : Float
+turnover_rate : Float
+collected_source : String
+collected_date : DateTime
}
class Base {
+__tablename__
+Column()
}
HistoricalQuotes --|> Base : "继承"
```

**Diagram sources**  
- [historical_quotes.py](file://backend_core/models/historical_quotes.py#L1-L27)

**Section sources**  
- [historical_quotes.py](file://backend_core/models/historical_quotes.py#L1-L27)

## 依赖清单

### 前端依赖 (admin/package.json)

| 类别 | 依赖项 | 版本 |
|------|--------|------|
| **核心框架** | vue | ^3.4.0 |
| | vue-router | ^4.2.0 |
| | pinia | ^2.1.0 |
| **UI组件** | element-plus | ^2.4.0 |
| | @element-plus/icons-vue | ^2.3.0 |
| **构建工具** | vite | ^4.5.0 |
| | @vitejs/plugin-vue | ^4.4.0 |
| **样式** | tailwindcss | ^3.3.0 |
| | autoprefixer | ^10.4.0 |
| **类型与工具** | typescript | ^5.2.0 |
| | vue-tsc | ^3.0.5 |
| | axios | ^1.6.0 |
| | dayjs | ^1.11.0 |

### 后端依赖 (backend_api/requirements.txt)

| 类别 | 依赖项 | 版本 |
|------|--------|------|
| **Web框架** | fastapi | >=0.115,<0.116 |
| | uvicorn | >=0.34.2,<0.35.0 |
| **数据库** | sqlalchemy | ==2.0.27 |
| | psycopg2-binary | ==2.9.10 |
| **数据处理** | pandas | ==2.2.0 |
| | numpy | ==1.26.4 |
| | akshare | ==1.16.95 |
| **数据验证** | pydantic | ==2.6.1 |
| | python-jose[cryptography] | ==3.3.0 |
| **工具** | python-dotenv | ==1.0.1 |
| | requests | >=2.32.1,<3.0.0 |
| | apscheduler | >=3.10.0 |

### 机器学习依赖 (backend_core/requirements.txt)

| 类别 | 依赖项 | 版本 |
|------|--------|------|
| **数据处理** | pandas | >=1.5.0 |
| | numpy | >=1.21.0 |
| | scipy | >=1.7.0 |
| **数据采集** | akshare | >=1.16.95 |
| | tushare | >=1.2.0 |
| **机器学习** | scikit-learn | >=1.0.0 |
| | xgboost | >=1.6.0 |
| | lightgbm | >=3.3.0 |
| | catboost | >=1.0.0 |
| **深度学习** | tensorflow | >=2.8.0 |
| | torch | >=1.12.0 |
| | transformers | >=4.20.0 |

## 环境搭建指南

### 前端环境搭建

1. 进入 `admin` 目录：
   ```bash
   cd admin
   ```

2. 安装依赖：
   ```bash
   npm install
   # 或使用 yarn
   yarn install
   ```

3. 启动开发服务器：
   ```bash
   npm run dev
   # 或
   yarn dev
   ```

4. 构建生产版本：
   ```bash
   npm run build
   # 或
   yarn build
   ```

### 后端环境搭建

1. 创建虚拟环境：
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

2. 安装生产依赖：
   ```bash
   pip install -r requirements.txt
   ```

3. 安装开发依赖（可选）：
   ```bash
   pip install -r requirements-dev.txt
   ```

4. 启动 FastAPI 服务：
   ```bash
   uvicorn backend_api.main:app --host 0.0.0.0 --port 5000 --reload
   ```

### 数据库配置

1. 确保 PostgreSQL 服务运行在 `localhost:5446`。

2. 创建数据库 `stock_analysis`。

3. 修改 `backend_core/database/db.py` 中的连接信息（如需）。

4. 初始化数据库表结构（需实现迁移脚本或手动执行 DDL）。

### 数据采集服务

1. 运行 AKShare 实时行情采集：
   ```bash
   cd backend_core
   python data_collectors/akshare/main.py --type realtime
   ```

2. 运行 Tushare 历史行情采集：
   ```bash
   python data_collectors/tushare/main.py --type historical --date 20240101
   ```