# 开发者指南

<cite>
**本文档引用的文件**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)
- [fastapi_python_cursor_rules_zh.md](file://backend_api/rules/fastapi_python_cursor_rules_zh.md)
- [frontend_technical_spec.md](file://frontend/rules/frontend_technical_spec.md)
- [test_bollinger_bands_optimization.py](file://test/test_bollinger_bands_optimization.py)
- [test_news_collector_fix.py](file://test/test_news_collector_fix.py)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py)
- [historical_quotes.py](file://backend_core/models/historical_quotes.py)
- [stock_analysis.py](file://backend_api/stock/stock_analysis.py)
- [stock_analysis_routes.py](file://backend_api/stock/stock_analysis_routes.py)
- [quotes_routes.py](file://backend_api/quotes_routes.py)
- [main.py](file://backend_api/main.py)
</cite>

## 目录
1. [代码风格规范](#代码风格规范)
2. [分支管理与提交信息](#分支管理与提交信息)
3. [本地开发与调试](#本地开发与调试)
4. [测试策略](#测试策略)
5. [功能扩展指南](#功能扩展指南)
6. [代码审查要点](#代码审查要点)
7. [性能测试方法](#性能测试方法)

## 代码风格规范

本项目遵循各模块技术规范，确保代码一致性与可维护性。

### 后端核心模块规范
遵循 `backend_core/rules/backend_core_technical_spec.md` 中的规范：
- **语言与格式**：使用 Python 3.8+，遵循 PEP8，4空格缩进，UTF-8编码。
- **文档与注释**：所有函数、类、模块必须包含文档字符串，复杂逻辑需添加详细注释。
- **异常处理**：统一异常处理机制，关键操作必须记录日志。
- **模块化设计**：采集、清洗、入库、调度等功能需模块化，便于维护和扩展。
- **日志管理**：建议按天分文件，重要异常需报警。

### API服务层规范
遵循 `backend_api/rules/fastapi_python_cursor_rules_zh.md` 中的规范：
- **编程范式**：优先使用函数式、声明式编程，避免过度使用类。
- **类型注解**：所有函数签名必须添加类型注解，输入校验优先使用 Pydantic 模型。
- **错误处理**：在函数开头处理错误和边界情况，使用 `if-return` 模式避免多层嵌套。
- **依赖注入**：使用 FastAPI 的依赖注入系统管理状态和共享资源。
- **异步操作**：I/O 密集型任务使用 `async def`，数据库和外部 API 调用必须异步。
- **性能优化**：静态和高频数据使用 Redis 或内存缓存，大数据集使用惰性加载。

### 前端模块规范
遵循 `frontend/rules/frontend_technical_spec.md` 中的规范：
- **代码风格**：JavaScript 使用2个空格缩进，单引号，行末加分号。
- **命名规范**：
  - 变量名：小驼峰命名（`stockList`）
  - 函数名：小驼峰命名（`getStockData`）
  - 常量：大写字母加下划线（`API_BASE_URL`）
  - 类名：大驼峰命名（`StockChart`）
- **文件命名**：HTML、JavaScript、CSS 文件使用小写字母加中划线分隔（`stock-detail.html`）。
- **CSS 规范**：使用 BEM 命名方法，类名使用小写字母和中划线（`stock-list__item--active`）。

**Section sources**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)
- [fastapi_python_cursor_rules_zh.md](file://backend_api/rules/fastapi_python_cursor_rules_zh.md)
- [frontend_technical_spec.md](file://frontend/rules/frontend_technical_spec.md)

## 分支管理与提交信息

### 分支策略
采用 Git 分支管理策略，确保开发流程有序：
- `main`：主分支，仅用于发布稳定版本，受保护。
- `develop`：开发主分支，集成所有功能分支。
- `feature/*`：功能分支，用于开发新功能，命名如 `feature/news-collector`。
- `bugfix/*`：修复分支，用于修复生产环境问题，命名如 `bugfix/login-error`。
- `release/*`：发布分支，用于版本发布前的测试和准备。

### 提交信息格式
提交信息必须遵循以下格式，确保清晰可追溯：
```
<类型>: <简短描述>

<详细描述>

<关联的Issue或任务ID>
```
- **类型**：`feat` (新功能), `fix` (修复), `docs` (文档), `style` (格式), `refactor` (重构), `test` (测试), `chore` (构建/工具)
- **简短描述**：不超过50字符，首字母小写，不加句号。
- **详细描述**：解释修改原因和影响，可分多行。
- **关联ID**：如 `Resolves #123` 或 `Related to TASK-456`

示例：
```
feat: 添加新闻采集器功能

实现基于akshare的市场新闻和股票新闻采集功能
支持分类、标签提取和数据库存储

Resolves #456
```

**Section sources**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)

## 本地开发与调试

### 环境准备
1. 安装 Python 3.8+ 和 Node.js。
2. 安装项目依赖：
   ```bash
   pip install -r requirements.txt
   pip install -r requirements-dev.txt
   ```
3. 配置数据库连接信息（参考 `env_example.txt`）。

### 调试技巧
利用 `test/` 目录下的测试脚本进行功能验证：

#### 布林带技术指标调试
使用 `test_bollinger_bands_optimization.py` 验证布林带计算和显示效果：
```python
# 运行测试脚本
python test/test_bollinger_bands_optimization.py
```
该脚本会：
- 测试布林带计算算法，验证使用样本标准差（n-1）的准确性。
- 展示视觉优化效果，包括中线样式、区域填充和颜色方案。
- 输出优化总结，确保显示效果接近主流股票软件。

#### 新闻采集器调试
使用 `test_news_collector_fix.py` 验证新闻采集功能：
```python
# 运行测试脚本
python test/test_news_collector_fix.py
```
该脚本会：
- 实例化 `NewsCollector` 类。
- 调用 `collect_market_news()` 方法采集市场新闻。
- 验证采集结果，输出前3条新闻的标题、内容、发布时间等信息。
- 判断采集是否成功，提供修复反馈。

**Section sources**
- [test_bollinger_bands_optimization.py](file://test/test_bollinger_bands_optimization.py)
- [test_news_collector_fix.py](file://test/test_news_collector_fix.py)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py)

## 测试策略

### 单元测试
- **框架**：使用 `pytest` 进行单元测试。
- **覆盖率**：核心模块测试覆盖率需 >80%。
- **测试用例**：覆盖正常路径、异常情况、边界条件和数据完整性。
- **隔离**：测试数据与生产数据隔离，测试后自动清理。

### 集成测试
- **API 测试**：使用 `test_api.py` 等脚本测试 API 接口的完整流程。
- **数据流测试**：验证从数据采集、清洗、入库到 API 响应的完整数据流。
- **依赖模拟**：使用 `mock` 库模拟外部依赖（如 akshare API）。

### 测试目录
- `backend_core/test/`：后端核心模块的单元测试。
- `backend_api/test/`：API 服务的集成测试。
- `test/`：通用测试脚本和功能验证。

**Section sources**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)
- [test_bollinger_bands_optimization.py](file://test/test_bollinger_bands_optimization.py)
- [test_news_collector_fix.py](file://test/test_news_collector_fix.py)

## 功能扩展指南

### 添加新的数据采集源
1. 在 `backend_core/data_collectors/` 目录下创建新模块（如 `new_source/`）。
2. 实现采集器类，继承通用基类或遵循统一接口。
3. 在配置文件 `config.py` 中注册新采集器。
4. 在调度器中添加新采集任务。
5. 编写单元测试，确保数据格式正确。

### 实现新的技术指标
1. 在 `backend_api/stock/stock_analysis.py` 的 `TechnicalIndicators` 类中添加新方法。
2. 方法需接受历史数据列表，返回计算结果。
3. 在 `StockAnalysisService` 中调用新指标。
4. 更新 `stock_analysis_routes.py` 的 API 响应，包含新指标。
5. 编写测试用例验证计算逻辑。

### 扩展API接口
1. 在 `backend_api/` 目录下创建新的路由模块（如 `new_feature_routes.py`）。
2. 使用 FastAPI 的 `APIRouter` 定义新路由。
3. 实现处理函数，遵循错误处理和校验规范。
4. 在 `main.py` 中导入并注册新路由。
5. 编写集成测试，验证接口功能。

**Section sources**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)
- [stock_analysis.py](file://backend_api/stock/stock_analysis.py)
- [stock_analysis_routes.py](file://backend_api/stock/stock_analysis_routes.py)
- [main.py](file://backend_api/main.py)

## 代码审查要点

审查代码时，重点关注以下方面：
- **规范遵循**：检查是否符合各模块的技术规范。
- **可读性**：代码是否清晰、易懂，命名是否恰当。
- **健壮性**：是否有充分的错误处理和边界检查。
- **性能**：是否有潜在的性能瓶颈，如阻塞 I/O 操作。
- **安全性**：输入是否校验，是否有 SQL 注入等风险。
- **测试**：是否有相应的测试用例，覆盖率是否足够。
- **文档**：函数和类是否有清晰的文档字符串。

**Section sources**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)
- [fastapi_python_cursor_rules_zh.md](file://backend_api/rules/fastapi_python_cursor_rules_zh.md)

## 性能测试方法

### API 性能测试
- **工具**：使用 `locust` 或 `wrk` 进行压力测试。
- **指标**：关注响应时间、延迟、吞吐量。
- **场景**：模拟高并发请求，测试 API 的稳定性和性能。

### 数据库性能测试
- **查询优化**：使用 `EXPLAIN` 分析慢查询，确保关键字段有索引。
- **批量操作**：测试批量写入和事务的性能。
- **连接池**：监控数据库连接池的使用情况。

### 前端性能测试
- **加载时间**：使用 Chrome DevTools 测量页面加载时间。
- **渲染性能**：检查是否有重排重绘问题。
- **资源优化**：确保静态资源已压缩，图片已优化。

**Section sources**
- [backend_core_technical_spec.md](file://backend_core/rules/backend_core_technical_spec.md)
- [fastapi_python_cursor_rules_zh.md](file://backend_api/rules/fastapi_python_cursor_rules_zh.md)