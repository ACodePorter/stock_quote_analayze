# 任务调度系统

<cite>
**本文档中引用的文件**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py)
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py)
- [config.py](file://backend_core/config/config.py)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py)
- [wechat_config.py](file://backend_core/wechat/wechat_config.py)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py)
- [db.py](file://backend_core/database/db.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细描述了`backend_core`模块中的任务调度机制，重点涵盖日报生成与推送、新闻采集周期执行、配置驱动的灵活调度策略、企业微信集成、任务注册与执行流程、监控与错误恢复机制。同时说明了调度冲突处理、任务依赖管理、日志记录等运维细节，并提供命令行启动和测试方法。

## 项目结构

```mermaid
graph TD
A[backend_core] --> B[config]
A --> C[scheduler]
A --> D[schedulers]
A --> E[wechat]
A --> F[reports]
A --> G[data_collectors]
A --> H[database]
B --> B1[config.py]
C --> C1[daily_report_scheduler.py]
D --> D1[news_scheduler.py]
E --> E1[wechat_service.py]
E --> E2[wechat_config.py]
F --> F1[csv_report_generator.py]
G --> G1[news_collector.py]
H --> H1[db.py]
```

**图示来源**  
- [config.py](file://backend_core/config/config.py)
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py)
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py)
- [db.py](file://backend_core/database/db.py)

**本节来源**  
- [backend_core](file://backend_core)

## 核心组件

本系统由多个核心组件构成，包括日报调度器、新闻调度器、微信服务、报告生成器、新闻采集器和数据库管理模块。这些组件协同工作，实现自动化任务调度与数据推送。

**本节来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py#L1-L175)

## 架构概览

```mermaid
graph TB
subgraph "调度层"
DR[日报调度器]
NS[新闻调度器]
end
subgraph "服务层"
WS[微信服务]
RG[报告生成器]
NC[新闻采集器]
end
subgraph "配置层"
CFG[config.py]
end
subgraph "数据层"
DB[(数据库)]
end
DR --> RG
DR --> WS
NS --> NC
NC --> DB
RG --> DB
WS --> DB
CFG --> DR
CFG --> NS
CFG --> WS
```

**图示来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [config.py](file://backend_core/config/config.py#L1-L47)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py#L1-L175)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py#L1-L428)
- [db.py](file://backend_core/database/db.py#L1-L32)

## 详细组件分析

### 日报调度器分析

`DailyReportScheduler` 类负责定时触发日报生成与推送流程。它通过 `schedule` 库注册每日 09:30 和 15:30 的定时任务，在股市开盘前和收盘后向用户发送股票持仓报告。

#### 类图
```mermaid
classDiagram
class DailyReportScheduler {
+report_generator : CSVReportGenerator
+wechat_service : WeChatService
+db : DatabaseManager
+get_active_users() Dict[]
+send_daily_report() void
+start_scheduler() void
}
class CSVReportGenerator {
+generate_summary_report(user_id) str
+generate_detailed_report(user_id, days) str
}
class WeChatService {
+send_file_message(user_ids, file_path, file_name) bool
+send_text_message(user_ids, content) bool
}
DailyReportScheduler --> CSVReportGenerator : "使用"
DailyReportScheduler --> WeChatService : "使用"
DailyReportScheduler --> DatabaseManager : "查询"
```

**图示来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py#L1-L175)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)

#### 执行流程时序图
```mermaid
sequenceDiagram
participant Scheduler as DailyReportScheduler
participant DB as DatabaseManager
participant RG as CSVReportGenerator
participant WS as WeChatService
Scheduler->>DB : get_active_users()
DB-->>Scheduler : 用户列表
loop 每个用户
Scheduler->>RG : generate_summary_report(user_id)
RG-->>Scheduler : 报告文件路径
Scheduler->>WS : send_file_message(wechat_user_id, 文件)
WS-->>Scheduler : 发送结果
Scheduler->>OS : 删除临时文件
end
Scheduler->>Console : 输出统计结果
```

**图示来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L50-L98)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py#L1-L175)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)

**本节来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [csv_report_generator.py](file://backend_core/reports/csv_report_generator.py#L1-L175)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)

### 新闻调度器分析

`news_scheduler.py` 管理新闻采集的周期性执行，包含三个主要任务：每30分钟采集市场新闻、每小时更新热门资讯、每天凌晨2点清理旧新闻。

#### 任务调度流程图
```mermaid
flowchart TD
Start([启动]) --> Setup["设置定时任务"]
Setup --> T1["每30分钟: collect_market_news_job"]
Setup --> T2["每小时: update_hot_news_job"]
Setup --> T3["每天02:00: cleanup_old_news_job"]
Setup --> Run["开始运行"]
Run --> Check["检查待执行任务"]
Check --> |有任务| Execute["执行任务"]
Execute --> Log["记录日志"]
Check --> |无任务| Wait["等待60秒"]
Wait --> Check
Execute --> Check
Run --> |Ctrl+C| Stop["安全退出"]
```

**图示来源**  
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py#L1-L428)

#### 新闻采集与保存流程
```mermaid
flowchart TD
Start([采集市场新闻]) --> AK["调用 ak.stock_news_main_cx()"]
AK --> DF{"返回数据?"}
DF --> |否| Warn["记录警告"]
DF --> |是| Process["处理每条新闻"]
Process --> Classify["分类新闻"]
Process --> Extract["提取摘要和标签"]
Process --> Save["保存到数据库"]
Save --> Check["检查是否已存在"]
Check --> |存在| Skip["跳过"]
Check --> |不存在| Insert["插入新记录"]
Insert --> Count["计数+1"]
Count --> Next["下一条"]
Next --> Process
Process --> Done["完成"]
Done --> Update["更新热门标记"]
Update --> Commit["提交事务"]
Commit --> Log["输出统计"]
```

**图示来源**  
- [news_collector.py](file://backend_core/data_collectors/news_collector.py#L1-L428)
- [db.py](file://backend_core/database/db.py#L1-L32)

**本节来源**  
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py#L1-L428)

### 配置管理分析

系统通过 `config.py` 实现灵活的调度策略配置，各模块从统一配置文件读取参数。

#### 配置结构
```mermaid
classDiagram
class Config {
+ROOT_DIR : Path
+DB_DIR : Path
+TUSHARE_CONFIG : Dict
+DATA_COLLECTORS : Dict
}
class DataCollectorConfig {
+max_retries : int
+retry_delay : int
+timeout : int
+log_dir : str
+db_file : str
+max_connection_errors : int
+token : str
}
Config "1" *-- "2" DataCollectorConfig : 包含
```

**图示来源**  
- [config.py](file://backend_core/config/config.py#L1-L47)

**本节来源**  
- [config.py](file://backend_core/config/config.py#L1-L47)

### 微信服务集成分析

`wechat_service.py` 实现了企业微信消息推送功能，支持文本和文件消息发送。

#### 企业微信服务类图
```mermaid
classDiagram
class WeChatService {
+config : WeChatConfig
+send_text_message(user_ids, content) bool
+send_file_message(user_ids, file_path, file_name) bool
+_upload_file(file_path) Optional~str~
}
class WeChatConfig {
+corp_id : str
+corp_secret : str
+agent_id : str
+access_token : str
+token_expires_at : int
+get_access_token() str
}
WeChatService --> WeChatConfig : "依赖"
```

**图示来源**  
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)
- [wechat_config.py](file://backend_core/wechat/wechat_config.py#L1-L37)

#### 文件消息发送时序
```mermaid
sequenceDiagram
participant WS as WeChatService
participant WC as WeChatConfig
participant API as 企业微信API
WS->>WC : get_access_token()
WC-->>WS : access_token
WS->>API : 上传文件(media/upload)
API-->>WS : media_id
WS->>API : 发送文件消息(message/send)
API-->>WS : 发送结果
WS-->>Caller : 成功/失败
```

**图示来源**  
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)
- [wechat_config.py](file://backend_core/wechat/wechat_config.py#L1-L37)

**本节来源**  
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)
- [wechat_config.py](file://backend_core/wechat/wechat_config.py#L1-L37)

## 依赖分析

```mermaid
graph LR
DR[日报调度器] --> RG[报告生成器]
DR --> WS[微信服务]
DR --> DB[数据库]
NS[新闻调度器] --> NC[新闻采集器]
NC --> DB
RG --> DB
WS --> WC[微信配置]
CFG[配置文件] --> DR
CFG --> NS
CFG --> NC
CFG --> WS
WC --> ENV[环境变量]
```

**图示来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [config.py](file://backend_core/config/config.py#L1-L47)
- [wechat_service.py](file://backend_core/wechat/wechat_service.py#L1-L71)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py#L1-L428)

**本节来源**  
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [config.py](file://backend_core/config/config.py#L1-L47)

## 性能考虑

系统在性能方面进行了多项优化：
- 数据库连接池配置（10个连接，最大溢出20个）
- 连接前ping检查和1小时回收机制
- 死锁超时设置为1秒，语句超时30秒
- 批量处理用户报告，减少数据库查询次数
- 临时文件及时清理，避免磁盘占用

**本节来源**  
- [db.py](file://backend_core/database/db.py#L1-L32)
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)

## 故障排除指南

### 常见问题与解决方案

| 问题现象 | 可能原因 | 解决方案 |
|---------|--------|--------|
| 报告未发送 | 用户无有效微信ID | 检查用户表wechat_user_id字段 |
| 新闻采集失败 | 网络连接问题 | 检查网络，确认akshare可访问 |
| 数据库连接超时 | 连接池耗尽 | 增加pool_size或优化查询 |
| 微信消息发送失败 | token失效 | 检查环境变量WECHAT_CORP_ID等 |
| 任务未执行 | 调度器未启动 | 检查启动脚本和日志 |

### 日志记录
系统在多个层级记录日志：
- `news_scheduler.py` 使用logging模块记录执行过程
- 各组件输出关键操作日志到控制台
- 错误信息包含详细异常堆栈

**本节来源**  
- [news_scheduler.py](file://backend_core/schedulers/news_scheduler.py#L1-L112)
- [daily_report_scheduler.py](file://backend_core/scheduler/daily_report_scheduler.py#L1-L98)
- [news_collector.py](file://backend_core/data_collectors/news_collector.py#L1-L428)

## 结论

本任务调度系统实现了日报生成推送和新闻采集两大核心功能，具有以下特点：
- 基于`schedule`库的灵活定时任务管理
- 配置驱动的可扩展架构
- 完善的错误处理和日志记录机制
- 企业微信集成实现消息推送
- 数据库优化保障系统稳定性

系统可通过命令行直接启动，支持实时监控和故障排查，为股票分析平台提供了可靠的后台自动化支持。